import React, { useState, useEffect } from 'react';
import { ClipboardList, History, AlertTriangle, Plus, Save, Trash2, Battery, Plane, MapPin, Users, FileText, RotateCcw } from 'lucide-react';

// --- Components ---

const Header = ({ activeTab, setActiveTab }) => (
    <header className="bg-slate-900 border-b border-amber-600/30 sticky top-0 z-50 shadow-lg">
        <div className="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
            <div className="flex items-center space-x-3">
                <div className="w-10 h-10 rounded-full border-2 border-amber-500 flex items-center justify-center bg-slate-800 shadow-[0_0_10px_rgba(212,175,55,0.3)]">
                    <Plane className="text-amber-500 w-6 h-6" />
                </div>
                <div>
                    <h1 className="text-lg md:text-xl font-bold text-white tracking-wide serif-font">
                        消防ドローン管理
                    </h1>
                    <p className="text-[10px] text-amber-500/80 uppercase tracking-widest">Safety Operation Log</p>
                </div>
            </div>
            <div className="text-xs text-slate-500 font-mono">
                Offline Mode
            </div>
        </div>
        
        {/* Navigation Tabs */}
        <div className="flex max-w-3xl mx-auto bg-slate-800/50 backdrop-blur-sm border-t border-slate-700">
            <TabButton 
                active={activeTab === 'input'} 
                onClick={() => setActiveTab('input')} 
                icon={<Plus size={18} />} 
                label="記録入力" 
            />
            <TabButton 
                active={activeTab === 'list'} 
                onClick={() => setActiveTab('list')} 
                icon={<ClipboardList size={18} />} 
                label="活動履歴" 
            />
            <TabButton 
                active={activeTab === 'safety'} 
                onClick={() => setActiveTab('safety')} 
                icon={<AlertTriangle size={18} />} 
                label="緊急対応" 
            />
        </div>
    </header>
);

const TabButton = ({ active, onClick, icon, label }) => (
    <button 
        onClick={onClick}
        className={`flex-1 flex flex-col items-center justify-center py-3 px-2 transition-all duration-300 relative overflow-hidden group ${active ? 'text-amber-400 bg-slate-800' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/50'}`}
    >
        <div className={`mb-1 transition-transform duration-300 ${active ? 'scale-110' : 'group-hover:scale-110'}`}>{icon}</div>
        <span className="text-xs font-bold tracking-wider">{label}</span>
        {active && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-amber-500 shadow-[0_0_8px_rgba(212,175,55,0.8)]"></div>}
    </button>
);

// 汎用確認モーダル
const Modal = ({ isOpen, title, message, onConfirm, onClose, confirmText = "OK", confirmColor = "bg-amber-500" }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] animate-fade-in px-4">
            <div className="bg-slate-900 border border-slate-600 p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 className="text-xl font-bold text-white mb-3 serif-font">{title}</h3>
                <p className="text-slate-300 mb-6 text-sm leading-relaxed">{message}</p>
                <div className="flex justify-end gap-3">
                    <button 
                        type="button"
                        onClick={onClose} 
                        className="px-4 py-2 rounded text-slate-400 hover:text-white hover:bg-slate-800 transition-colors text-sm"
                    >
                        キャンセル
                    </button>
                    <button 
                        type="button"
                        onClick={onConfirm} 
                        className={`px-4 py-2 rounded ${confirmColor} text-slate-900 font-bold hover:shadow-lg transition-transform transform hover:scale-105 text-sm`}
                    >
                        {confirmText}
                    </button>
                </div>
            </div>
        </div>
    );
};

const EmergencyGuide = () => (
    <div className="animate-fade-in pb-10">
        <div className="bg-red-950/40 border border-red-500/30 rounded-lg p-4 mb-6 shadow-[0_0_15px_rgba(220,38,38,0.1)]">
            <h3 className="text-red-400 font-bold text-lg mb-2 flex items-center">
                <AlertTriangle className="mr-2" />
                <span>事故発生時の緊急対応フロー</span>
            </h3>
            <p className="text-sm text-red-200/80">
                事故発生時は冷静かつ迅速に以下の手順で対応してください。人命救助・安全確保が最優先です。
            </p>
        </div>

        <div className="space-y-6">
            <section className="bg-slate-800 p-5 rounded-lg border-l-4 border-amber-500 shadow-lg">
                <h4 className="text-white font-bold text-lg mb-3 flex items-center">
                    <span className="bg-amber-500 text-slate-900 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2 font-bold">1</span>
                    直ちに行う措置（安全確保）
                </h4>
                <ul className="list-none space-y-3 text-slate-300 text-sm pl-2">
                    <li className="flex items-start"><span className="text-amber-500 mr-2">●</span><span><strong className="text-white">飛行の中止：</strong> 制御可能な場合は直ちに着陸させる。</span></li>
                    <li className="flex items-start"><span className="text-amber-500 mr-2">●</span><span><strong className="text-white">負傷者の救護：</strong> 負傷者がいる場合は、救急要請および応急手当を行う。</span></li>
                    <li className="flex items-start"><span className="text-amber-500 mr-2">●</span><span><strong className="text-white">二次被害の防止：</strong> 火災の延焼防止、落下地点への立入制限など。</span></li>
                    <li className="flex items-start"><span className="text-amber-500 mr-2">●</span><span><strong className="text-white">機体の保全：</strong> 証拠保全のため、むやみに機体を移動させない（二次被害の恐れがある場合を除く）。</span></li>
                </ul>
            </section>

            <section className="bg-slate-800 p-5 rounded-lg border-l-4 border-blue-500 shadow-lg">
                <h4 className="text-white font-bold text-lg mb-3 flex items-center">
                    <span className="bg-blue-500 text-slate-900 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2 font-bold">2</span>
                    連絡・報告体制
                </h4>
                <div className="text-sm text-slate-300 space-y-3 pl-2">
                    <p>事故の規模に関わらず、速やかに所属本部へ第一報を入れること。</p>
                    <div className="bg-slate-900/80 p-4 rounded border border-slate-700">
                        <p className="text-xs text-blue-400 mb-2 font-bold uppercase tracking-wider">報告必須項目</p>
                        <ul className="list-none space-y-1">
                            <li>□ 発生日時・場所</li>
                            <li>□ 事故の概要（墜落、接触、紛失など）</li>
                            <li>□ 被害状況（人的被害、物的被害）</li>
                            <li>□ 現在の措置状況</li>
                        </ul>
                    </div>
                    <p className="pt-2 text-xs text-slate-400">
                        <span className="block font-bold text-white mb-1">関係各所への通報（必要に応じて）</span>
                        警察（110番）、空港事務所（航空管制圏内の場合）、国土交通省（事故報告システムへの登録は後日でも可だが速やかに）。
                    </p>
                </div>
            </section>

            <section className="bg-slate-800 p-5 rounded-lg border-l-4 border-slate-500 shadow-lg">
                <h4 className="text-white font-bold text-lg mb-3 flex items-center">
                    <span className="bg-slate-500 text-slate-900 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2 font-bold">3</span>
                    紛失時の対応
                </h4>
                <ul className="list-none space-y-2 text-slate-300 text-sm pl-2">
                    <li>・飛行経路下の徹底的な捜索を実施。</li>
                    <li>・警察へ遺失物届出を行う。</li>
                    <li>・国土交通省へ「紛失」として事故報告を行う義務あり。</li>
                    <li>・保険会社への連絡（賠償責任保険等）。</li>
                </ul>
            </section>
        </div>
    </div>
);

const LogForm = ({ onSave }) => {
    const initialState = {
        date: new Date().toISOString().substring(0, 16),
        location: '',
        missionType: '火災防御',
        droneId: '',
        batteryCount: '1',
        batteryStart: '100',
        batteryEnd: '',
        pilot: '',
        observer: '',
        notes: ''
    };

    const [formData, setFormData] = useState(initialState);
    const [showResetModal, setShowResetModal] = useState(false);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleResetConfirm = () => {
        setFormData(initialState);
        setShowResetModal(false);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
        setFormData(prev => ({
            ...initialState,
            date: new Date().toISOString().substring(0, 16),
            pilot: prev.pilot,
            observer: prev.observer,
            location: prev.location, 
            droneId: prev.droneId 
        }));
    };

    return (
        <>
            <form onSubmit={handleSubmit} className="animate-fade-in bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700 pb-10">
                <h3 className="text-xl font-bold text-white mb-6 serif-font border-b border-slate-700 pb-3 flex items-center">
                    <FileText className="mr-2 text-amber-500" /> 新規フライト記録
                </h3>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Basic Info */}
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">日時</label>
                            <input required type="datetime-local" name="date" value={formData.date} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" />
                        </div>
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">活動場所</label>
                            <div className="relative">
                                <MapPin className="absolute left-3 top-3.5 text-slate-500 w-4 h-4" />
                                <input required type="text" name="location" placeholder="例: 〇〇市△△町 1-1" value={formData.location} onChange={handleChange} className="w-full p-3 pl-10 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">活動種別</label>
                            <select name="missionType" value={formData.missionType} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none">
                                <option>火災防御（延焼監視・飛び火警戒）</option>
                                <option>救助活動（山間部捜索・水難救助）</option>
                                <option>特殊災害（NBC・危険物）</option>
                                <option>情報収集・調査</option>
                                <option>訓練・点検</option>
                            </select>
                        </div>
                    </div>

                    {/* Drone & Battery */}
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">使用機体名 / ID</label>
                            <input required type="text" name="droneId" placeholder="例: Matrice 300 RTK (No.1)" value={formData.droneId} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" />
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3">
                            <div className="col-span-1">
                                <label className="block text-xs text-slate-400 mb-1">使用本数</label>
                                <input type="number" name="batteryCount" min="1" value={formData.batteryCount} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none" />
                            </div>
                            <div className="col-span-1">
                                <label className="block text-xs text-slate-400 mb-1">開始(%)</label>
                                <input type="number" name="batteryStart" placeholder="100" value={formData.batteryStart} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none" />
                            </div>
                            <div className="col-span-1">
                                <label className="block text-xs text-slate-400 mb-1">終了(%)</label>
                                <input type="number" name="batteryEnd" placeholder="30" value={formData.batteryEnd} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none" />
                            </div>
                        </div>
                    </div>

                    {/* Personnel */}
                    <div className="space-y-4 md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">操縦者 (PILOT)</label>
                            <div className="relative">
                                <Users className="absolute left-3 top-3.5 text-slate-500 w-4 h-4" />
                                <input required type="text" name="pilot" placeholder="階級 氏名" value={formData.pilot} onChange={handleChange} className="w-full p-3 pl-10 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs text-amber-500 mb-1 font-bold">目視監視者 / 補助者</label>
                            <div className="relative">
                                <Users className="absolute left-3 top-3.5 text-slate-500 w-4 h-4" />
                                <input required type="text" name="observer" placeholder="階級 氏名" value={formData.observer} onChange={handleChange} className="w-full p-3 pl-10 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" />
                            </div>
                        </div>
                    </div>

                    {/* Notes */}
                    <div className="md:col-span-2">
                        <label className="block text-xs text-slate-400 mb-1">備考・特記事項（ヒヤリハット等）</label>
                        <textarea name="notes" rows="3" value={formData.notes} onChange={handleChange} className="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-colors" placeholder="風速状況、電波状況、気になる点など"></textarea>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-3">
                    <button 
                        type="button" 
                        onClick={() => setShowResetModal(true)}
                        className="border border-slate-600 hover:border-slate-400 text-slate-400 hover:text-white font-bold py-3 px-6 rounded shadow flex items-center transition-all"
                    >
                        <RotateCcw className="mr-2 w-5 h-5" />
                        リセット
                    </button>
                    <button 
                        type="submit" 
                        className="bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-slate-900 font-bold py-3 px-8 rounded shadow-lg flex items-center transform hover:-translate-y-0.5 transition-all"
                    >
                        <Save className="mr-2 w-5 h-5" />
                        記録を保存
                    </button>
                </div>
            </form>

            <Modal 
                isOpen={showResetModal}
                title="入力のリセット"
                message="現在入力中の内容をすべて消去して、初期状態に戻しますか？"
                confirmText="リセットする"
                confirmColor="bg-slate-200 hover:bg-white"
                onConfirm={handleResetConfirm}
                onClose={() => setShowResetModal(false)}
            />
        </>
    );
};

const LogList = ({ logs, onRequestDelete }) => {
    if (logs.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center py-20 text-slate-600 animate-fade-in">
                <History size={48} className="mb-4 opacity-50" />
                <p>記録データがありません。</p>
                <p className="text-sm mt-2">新しいフライト記録を追加してください。</p>
            </div>
        );
    }

    return (
        <div className="space-y-4 animate-fade-in pb-10">
            {logs.map(log => (
                <div key={log.id} className="bg-slate-800 rounded-lg border border-slate-700 p-5 shadow-lg hover:border-amber-500/30 transition-all group">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <div className="text-amber-500 font-bold text-lg serif-font flex items-center">
                                <span className="w-2 h-2 bg-amber-500 rounded-full mr-2"></span>
                                {log.date.replace('T', ' ')}
                            </div>
                            <div className="text-white font-bold text-lg mt-1">{log.missionType}</div>
                            <div className="text-slate-400 text-sm flex items-center mt-1">
                                <MapPin size={14} className="mr-1" /> {log.location}
                            </div>
                        </div>
                        <button onClick={() => onRequestDelete(log.id)} className="text-slate-600 hover:text-red-400 p-2 transition-colors rounded-full hover:bg-slate-700">
                            <Trash2 size={18} />
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 text-sm text-slate-300 border-t border-slate-700/50 pt-4 mt-2">
                        <div className="space-y-1">
                            <p className="text-xs text-slate-500 uppercase tracking-wider">機体情報</p>
                            <p className="font-medium text-slate-200">{log.droneId}</p>
                            <div className="flex items-center text-amber-500/80">
                                <Battery size={14} className="mr-1" />
                                <span>{log.batteryStart}% <span className="text-slate-500 mx-1">→</span> {log.batteryEnd}% <span className="text-slate-500 text-xs ml-1">({log.batteryCount}本)</span></span>
                            </div>
                        </div>
                        <div className="space-y-1">
                            <p className="text-xs text-slate-500 uppercase tracking-wider">体制</p>
                            <p><span className="text-slate-500 text-xs mr-1">操縦:</span> {log.pilot}</p>
                            <p><span className="text-slate-500 text-xs mr-1">監視:</span> {log.observer}</p>
                        </div>
                    </div>
                    {log.notes && (
                        <div className="mt-4 bg-slate-900/60 p-3 rounded text-sm text-slate-400 italic border-l-2 border-slate-600">
                            "{log.notes}"
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
};

// Main App Container
const App = () => {
    // --- LocalStorage Logic ---
    const [logs, setLogs] = useState([]);
    const [activeTab, setActiveTab] = useState('input');
    const [deleteTargetId, setDeleteTargetId] = useState(null);

    // Load data from LocalStorage on mount
    useEffect(() => {
        const savedLogs = localStorage.getItem('fire_drone_logs');
        if (savedLogs) {
            try {
                setLogs(JSON.parse(savedLogs));
            } catch (e) {
                console.error("Failed to load logs:", e);
            }
        }
    }, []);

    // Save data to LocalStorage
    const saveToLocal = (newLogs) => {
        setLogs(newLogs);
        localStorage.setItem('fire_drone_logs', JSON.stringify(newLogs));
    };

    const handleSave = (data) => {
        const newLog = {
            id: Date.now().toString(),
            ...data,
            createdAt: new Date().toISOString()
        };
        const updatedLogs = [newLog, ...logs];
        saveToLocal(updatedLogs);
        setActiveTab('list');
    };

    const handleDeleteRequest = (id) => {
        setDeleteTargetId(id);
    };

    const executeDelete = () => {
        if (deleteTargetId) {
            const updatedLogs = logs.filter(log => log.id !== deleteTargetId);
            saveToLocal(updatedLogs);
            setDeleteTargetId(null);
        }
    };

    return (
        <div className="min-h-screen bg-slate-900 pb-20 text-slate-200">
            {/* Styles Injection */}
            <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
                
                .serif-font {
                    font-family: 'Shippori Mincho', serif;
                }
                .animate-fade-in {
                    animation: fadeIn 0.4s ease-out forwards;
                }
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `}</style>

            <Header activeTab={activeTab} setActiveTab={setActiveTab} />

            {/* Main Content */}
            <main className="max-w-3xl mx-auto px-4 py-6">
                {activeTab === 'input' && <LogForm onSave={handleSave} />}
                {activeTab === 'list' && <LogList logs={logs} onRequestDelete={handleDeleteRequest} />}
                {activeTab === 'safety' && <EmergencyGuide />}
            </main>

            {/* Delete Confirmation Modal */}
            <Modal 
                isOpen={!!deleteTargetId}
                title="記録の削除"
                message="このフライト記録を完全に削除してもよろしいですか？この操作は取り消せません。"
                confirmText="削除する"
                confirmColor="bg-red-500 hover:bg-red-600 text-white"
                onConfirm={executeDelete}
                onClose={() => setDeleteTargetId(null)}
            />
        </div>
    );
};

export default App;
