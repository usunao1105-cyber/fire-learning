<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>装備＆活動記録アプリ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoom-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation-fill-mode: forwards; }
        .fade-in { animation-name: fade-in; }
        .slide-in-from-bottom-2 { animation-name: slide-up; }
        .zoom-in { animation-name: zoom-in; }
        .duration-300 { animation-duration: 300ms; }
        .animate-spin-slow { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            ShieldCheck, Droplets, Search, History, PlusCircle, Calendar, 
            CheckCircle2, AlertCircle, Trash2, HardHat, Footprints, Shirt, 
            HandMetal, Settings, AlertTriangle, Clock, Flame, Activity, 
            FileText, Download, User as UserIcon, Edit3, ShoppingBag, Tag, 
            RotateCcw, RefreshCw, Zap, BookOpen, ChevronRight, ChevronLeft, X, Loader2, Save, AlertOctagon, Check
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, onAuthStateChanged, signInAnonymously 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            Timestamp, deleteDoc, doc, setDoc, getDoc, writeBatch 
        } from 'firebase/firestore';

        // ==========================================
        // 【重要】Firebase設定エリア
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDdp0ELCqMqoAAsCvW-TxMJHw3nvuREm_k",
  authDomain: "fire-report-app-3e6d7.firebaseapp.com",
  projectId: "fire-report-app-3e6d7",
  storageBucket: "fire-report-app-3e6d7.firebasestorage.app",
  messagingSenderId: "918018696612",
  appId: "1:918018696612:web:5461507c049dde4e71cd31"
        };
        // ==========================================

        const APP_IDENTIFIER = 'activity-maintenance-app';

        let app, auth, db;
        let configStatus = "default";

        // 設定チェック
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
            configStatus = "default";
        } else {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                configStatus = "valid";
            } catch (e) {
                console.error("Firebase Init Error:", e);
                configStatus = "invalid";
            }
        }

        // --- Helper Functions ---
        const getMonthString = (date) => `${date.getFullYear()}年${date.getMonth() + 1}月`;
        const getTypeName = (type) => type === 'inspection' ? '点検' : type === 'laundry' ? '洗濯' : type === 'waterproof' ? '撥水' : 'その他';
        const getFireTypeName = (type) => ({'building':'建物火災','vehicle':'車両火災','chemical':'化学火災','other':'その他火災','training':'訓練','none':'なし'})[type] || '未分類';
        const getFireTypeColor = (type) => ({'chemical':'bg-purple-100 text-purple-700 border-purple-200','vehicle':'bg-red-100 text-red-700 border-red-200','building':'bg-orange-100 text-orange-700 border-orange-200'})[type] || 'bg-slate-100 text-slate-700 border-slate-200';
        const getEquipmentTypeName = (type) => ({'helmet':'ヘルメット','jacket':'防火衣(上)','trousers':'防火衣(下)','boots':'長靴','gloves':'手袋','other':'その他'}[type]);
        const getEquipmentIcon = (type) => {
            switch(type){
                case 'helmet': return <HardHat className="w-5 h-5"/>;
                case 'jacket': return <Shirt className="w-5 h-5"/>;
                case 'trousers': return <div className="w-5 h-5 flex flex-col items-center justify-center"><div className="w-3/4 h-1/2 border-2 border-current border-t-0 rounded-b-sm"/></div>;
                case 'boots': return <Footprints className="w-5 h-5"/>;
                case 'gloves': return <HandMetal className="w-5 h-5"/>;
                default: return <ShieldCheck className="w-5 h-5"/>;
            }
        };
        const getTypeIcon = (type, className="w-5 h-5") => type==='inspection'?<Search className={className}/>:type==='laundry'?<Droplets className={className}/>:<ShieldCheck className={className}/>;
        const getTypeColor = (type) => type==='inspection'?'bg-blue-100 text-blue-700 border-blue-200':type==='laundry'?'bg-teal-100 text-teal-700 border-teal-200':'bg-indigo-100 text-indigo-700 border-indigo-200';
        const calculateAge = (date) => {
            const diffTime = Math.abs(new Date().getTime() - date.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return { years: Math.floor(diffDays / 365), months: Math.floor((diffDays % 365) / 30) };
        };
        const formatDuration = (minutes) => {
            const h = Math.floor(minutes / 60);
            return h > 0 ? `${h}時間${minutes % 60}分` : `${minutes % 60}分`;
        };
        const formatDateForInput = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            return (new Date(date.getTime() - offset)).toISOString().slice(0, 16);
        };

        // --- Error Handler ---
        const handleError = (e, actionName) => {
            console.error(actionName, e);
            if (e.code === 'permission-denied') {
                alert(`【エラー】${actionName}できませんでした。\n\n原因：データベースのアクセス権限がありません。\n\n対策：\nFirebaseコンソールの「Firestore Database」＞「ルール」を開き、以下のコードに書き換えて「公開」してください。\n\nallow read, write: if true;`);
            } else if (e.code === 'unavailable') {
                alert(`【エラー】${actionName}できませんでした。\n\n原因：インターネットに接続されていないか、Firebaseサービスに一時的な問題があります。`);
            } else {
                alert(`【エラー】${actionName}中に問題が発生しました。\n\n詳細: ${e.message}`);
            }
        };

        // --- Components ---
        const SetupGuide = ({ error }) => {
            let title = "設定が必要です";
            let message = "Firebaseの設定が完了していないか、エラーが発生しています。";
            let guideType = "config";

            if (configStatus === "default") {
                title = "1. APIキーの設定";
                message = "コード内の firebaseConfig が初期状態のままです。Firebaseコンソールから設定をコピーして貼り付けてください。";
                guideType = "config";
            } else if (error && (error.code === 'auth/operation-not-allowed' || error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation')) {
                title = "2. 匿名ログインの有効化";
                message = "Firebaseの設定で「匿名ログイン」が無効になっています。コンソールで有効にしてください。";
                guideType = "auth";
            } else if (error && error.code === 'permission-denied') {
                title = "3. データベースの権限設定";
                message = "Firestoreのセキュリティルールによりアクセスが拒否されました。テストモードに変更してください。";
                guideType = "firestore";
            } else if (error) {
                title = "エラーが発生しました";
                message = `詳細: ${error.message}`;
            }

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-100 font-sans">
                    <div className="bg-white max-w-lg w-full p-6 rounded-2xl shadow-xl border-l-4 border-orange-500">
                        <div className="flex items-start gap-4 mb-6">
                            <div className="bg-orange-100 p-3 rounded-full shrink-0"><AlertTriangle className="w-8 h-8 text-orange-600" /></div>
                            <div><h1 className="text-xl font-bold text-slate-800 mb-2">{title}</h1><p className="text-sm text-slate-600 leading-relaxed">{message}</p></div>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-lg text-sm text-slate-700 border border-slate-200">
                            <h2 className="font-bold mb-3 flex items-center gap-2"><CheckCircle2 className="w-4 h-4 text-green-600"/> 解決手順:</h2>
                            {guideType === "config" && <ol className="list-decimal pl-5 space-y-2"><li><a href="https://console.firebase.google.com/" target="_blank" className="text-blue-600 underline font-bold">Firebaseコンソール</a>を開く</li><li>プロジェクト設定の「マイアプリ」から <code>firebaseConfig</code> をコピー</li><li>このファイルの80行目付近を上書き保存</li></ol>}
                            {guideType === "auth" && <ol className="list-decimal pl-5 space-y-2"><li>Firebaseコンソールで<strong>「Authentication」</strong>を開く</li><li><strong>「Sign-in method」</strong>タブで<strong>「匿名」</strong>を有効にする</li><li>このページをリロード</li></ol>}
                            {guideType === "firestore" && <ol className="list-decimal pl-5 space-y-2"><li>Firebaseコンソールで<strong>「Firestore Database」</strong>→<strong>「ルール」</strong>を開く</li><li>ルールを <code>allow read, write: if true;</code> に書き換えて公開</li><li>このページをリロード</li></ol>}
                        </div>
                    </div>
                </div>
            );
        };

        const GuideScene1 = () => (
            <svg viewBox="0 0 200 150" className="w-full h-auto rounded-xl bg-slate-50 border border-slate-200">
                <style>{`@keyframes pulse-btn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); fill: #f97316; } } .btn-anim { animation: pulse-btn 2s infinite ease-in-out; }`}</style>
                <rect x="50" y="10" width="100" height="130" rx="8" fill="white" stroke="#94a3b8" strokeWidth="2" />
                <rect x="55" y="15" width="90" height="10" rx="2" fill="#e2e8f0" />
                <circle cx="75" cy="45" r="12" fill="#fed7aa" className="btn-anim" />
                <path d="M70 45 L73 48 L80 41" stroke="#c2410c" strokeWidth="2" fill="none" />
                <circle cx="100" cy="45" r="10" fill="#e2e8f0" />
                <circle cx="125" cy="45" r="10" fill="#e2e8f0" />
                <rect x="60" y="70" width="80" height="60" rx="4" fill="white" stroke="#cbd5e1" strokeWidth="1" />
                <text x="80" y="100" fontSize="8" fill="#64748b">記録イメージ</text>
            </svg>
        );
        const GuideScene2 = () => <GuideScene1 />;
        const GuideScene3 = () => <GuideScene1 />;

        const ActivityMaintenanceApp = () => {
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState(null); 
            const [dbError, setDbError] = useState(null);     

            const [userName, setUserName] = useState('');
            const [logs, setLogs] = useState([]);
            const [equipmentList, setEquipmentList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const [isLogModalOpen, setIsLogModalOpen] = useState(false);
            const [isEquipModalOpen, setIsEquipModalOpen] = useState(false);
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [isManualModalOpen, setIsManualModalOpen] = useState(false);

            const [selectedLogType, setSelectedLogType] = useState('inspection');
            const [logNotes, setLogNotes] = useState('');
            const [chemicalExposure, setChemicalExposure] = useState(false);
            const [selectedEquipmentIds, setSelectedEquipmentIds] = useState([]);
            const [fireType, setFireType] = useState('none');
            const [activityDuration, setActivityDuration] = useState(''); 
            const [incidentDateStr, setIncidentDateStr] = useState(''); 
            const [incidentName, setIncidentName] = useState('');

            const [newEquipName, setNewEquipName] = useState('');
            const [newEquipType, setNewEquipType] = useState('jacket');
            const [newEquipDate, setNewEquipDate] = useState('');
            const [newEquipLifespan, setNewEquipLifespan] = useState(3); 
            const [newEquipVendor, setNewEquipVendor] = useState(''); 
            const [newEquipSpec, setNewEquipSpec] = useState('');
            const [editUserName, setEditUserName] = useState('');
            const [manualPage, setManualPage] = useState(0);

            // Auth Initialization
            useEffect(() => {
                if (configStatus !== "valid") return;

                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Auth Error", error);
                            setAuthError(error);
                        });
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user) return;

                const logsQuery = query(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs'), orderBy('date', 'desc'));
                const unsubLogs = onSnapshot(logsQuery, (snapshot) => {
                    const fetchedLogs = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date?.toDate ? data.date.toDate() : new Date(),
                            incidentDate: data.incidentDate?.toDate ? data.incidentDate.toDate() : undefined,
                        };
                    });
                    setLogs(fetchedLogs);
                    setLoading(false);
                }, (err) => {
                    console.error("Log Fetch Error", err);
                    if(err.code === 'permission-denied') setDbError(err);
                    setLoading(false);
                });

                const equipQuery = query(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment'));
                const unsubEquip = onSnapshot(equipQuery, (snapshot) => {
                    const fetchedEquip = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            deployDate: data.deployDate?.toDate ? data.deployDate.toDate() : new Date(),
                        };
                    });
                    const typeOrder = { helmet: 1, jacket: 2, trousers: 3, boots: 4, gloves: 5, other: 6 };
                    fetchedEquip.sort((a, b) => (typeOrder[a.type] || 99) - (typeOrder[b.type] || 99));
                    setEquipmentList(fetchedEquip);
                }, (err) => {
                    if(err.code === 'permission-denied') setDbError(err);
                });

                const profileRef = doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'settings', 'profile');
                getDoc(profileRef).then(docSnap => {
                    if (docSnap.exists()) setUserName(docSnap.data().displayName || '');
                });

                return () => { unsubLogs(); unsubEquip(); };
            }, [user]);

            if (configStatus === "default" || authError || dbError) {
                return <SetupGuide error={authError || dbError} />;
            }

            // --- Handlers ---
            const handleAddLog = async () => {
                setIsSubmitting(true);
                try {
                    const logData = {
                        type: selectedLogType,
                        date: Timestamp.now(),
                        notes: logNotes,
                        chemicalExposure: chemicalExposure,
                        targetEquipmentIds: selectedEquipmentIds,
                        fireType: fireType,
                        activityDurationMinutes: activityDuration ? parseInt(activityDuration) : 0,
                        incidentName: incidentName,
                    };
                    if (incidentDateStr) {
                        logData.incidentDate = Timestamp.fromDate(new Date(incidentDateStr));
                    }
                    await addDoc(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs'), logData);
                    setIsLogModalOpen(false);
                    resetLogForm();
                } catch (error) {
                    handleError(error, "記録");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleAddEquipment = async () => {
                if (!newEquipName.trim()) {
                    alert("「装備名」を入力してください");
                    return;
                }
                setIsSubmitting(true);
                try {
                    const d = newEquipDate ? new Date(newEquipDate) : new Date();
                    await addDoc(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment'), {
                        name: newEquipName,
                        type: newEquipType,
                        deployDate: Timestamp.fromDate(d),
                        lifespanYears: Number(newEquipLifespan) || 3,
                        vendor: newEquipVendor,
                        specification: newEquipSpec,
                    });
                    setIsEquipModalOpen(false);
                    resetEquipForm();
                } catch (error) {
                    handleError(error, "装備追加");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleDeleteLog = async (id) => {
                if(!confirm("削除しますか？")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs', id));
                } catch(e) { handleError(e, "削除"); }
            };

            const handleDeleteEquipment = async (id) => {
                if(!confirm("削除しますか？")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment', id));
                } catch(e) { handleError(e, "削除"); }
            };

            const handleSaveProfile = async () => {
                setIsSubmitting(true);
                try {
                    await setDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'settings', 'profile'), { displayName: editUserName });
                    setUserName(editUserName);
                    setIsProfileModalOpen(false);
                } catch (e) { handleError(e, "プロフィール保存"); } finally { setIsSubmitting(false); }
            };

            const handleResetAllData = async () => {
                if(!confirm("本当に全てのデータを削除しますか？")) return;
                
                // データがない場合
                if (logs.length === 0 && equipmentList.length === 0) {
                    alert("削除するデータがありません。");
                    return;
                }

                setIsSubmitting(true);
                try {
                    const batch = writeBatch(db);
                    logs.forEach(l => batch.delete(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs', l.id)));
                    equipmentList.forEach(e => batch.delete(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment', e.id)));
                    await batch.commit();
                    alert("完了しました");
                    setIsProfileModalOpen(false);
                } catch(e) { handleError(e, "初期化"); } finally { setIsSubmitting(false); }
            };

            const handleExportCSV = () => {
                if(logs.length===0) return alert("データがありません");
                const header = ["氏名","日時","種別","火災種別","場所","発生日時","活動(分)","化学曝露","装備","備考"].join(",");
                const rows = logs.map(l => {
                    const equip = l.targetEquipmentIds.map(id => equipmentList.find(e=>e.id===id)?.name || "").join("/");
                    return [`"${userName}"`, l.date.toLocaleString(), getTypeName(l.type), getFireTypeName(l.fireType||'none'), `"${l.incidentName||''}"`, l.incidentDate?.toLocaleString()||'-', l.activityDurationMinutes||0, l.chemicalExposure?'あり':'なし', `"${equip}"`, `"${l.notes||''}"`].join(",");
                });
                const blob = new Blob(["\uFEFF"+[header,...rows].join("\n")], {type:'text/csv;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = `report.csv`; a.click();
            };

            const resetLogForm = () => {
                setLogNotes(''); setChemicalExposure(false); setSelectedEquipmentIds([]);
                setFireType('none'); setActivityDuration(''); setIncidentDateStr(''); setIncidentName('');
            };
            const resetEquipForm = () => {
                setNewEquipName(''); setNewEquipType('jacket'); setNewEquipDate('');
                setNewEquipLifespan(3); setNewEquipVendor(''); setNewEquipSpec('');
            };

            const openLogModal = (type) => {
                setSelectedLogType(type);
                setSelectedEquipmentIds(equipmentList.map(e => e.id));
                setFireType('none');
                setIncidentDateStr(formatDateForInput(new Date()));
                setIsLogModalOpen(true);
            };

            const openProfileModal = () => {
                setEditUserName(userName);
                setIsProfileModalOpen(true);
            };

            // Stats
            const exposureStats = logs.reduce((acc, log) => {
                if (log.fireType === 'training') return acc;
                const isChemical = log.fireType === 'chemical' || log.chemicalExposure;
                const isOther = !isChemical && (log.fireType && log.fireType !== 'none');
                if (isChemical) {
                    acc.chemicalCount += 1;
                    acc.chemicalDuration += (log.activityDurationMinutes || 0);
                } else if (isOther) {
                    acc.otherCount += 1;
                    acc.otherDuration += (log.activityDurationMinutes || 0);
                }
                return acc;
            }, { chemicalCount: 0, chemicalDuration: 0, otherCount: 0, otherDuration: 0 });

            const currentMonth = new Date();
            const status = {
                inspection: logs.some(l => l.type === 'inspection' && l.date.getMonth() === currentMonth.getMonth()),
                laundry: logs.some(l => l.type === 'laundry' && l.date.getMonth() === currentMonth.getMonth()),
                waterproof: logs.some(l => l.type === 'waterproof' && l.date.getMonth() === currentMonth.getMonth()),
            };

            const manualSlides = [
                { title: "1. 活動を記録する", description: "「点検」「洗濯」「撥水」ボタンから記録開始。火災種別や活動時間を入力するとリスク管理データとして蓄積。", component: <GuideScene1 /> },
                { title: "2. 装備を管理する", description: "装備品を登録すると使用年数が自動計算され、耐用年数が近づくとアラートでお知らせします。", component: <GuideScene2 /> },
                { title: "3. データを活用する", description: "蓄積されたデータはCSVファイルとしてダウンロード可能。報告書や健康管理手帳の作成に役立ちます。", component: <GuideScene3 /> }
            ];

            if (loading && !authError && !dbError) return <div className="min-h-screen flex items-center justify-center bg-slate-100 text-slate-500"><div className="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-500"></div></div>;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 pb-20">
                    <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-lg font-bold flex items-center gap-2"><ShieldCheck className="text-orange-500"/> 装備＆活動記録</h1>
                                {userName && <div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><UserIcon className="w-3 h-3"/>{userName}</div>}
                            </div>
                            <div className="flex gap-2">
                                <button type="button" onClick={() => { setManualPage(0); setIsManualModalOpen(true); }} className="p-2 hover:bg-white/10 rounded-full"><BookOpen className="w-5 h-5"/></button>
                                <button type="button" onClick={openProfileModal} className="p-2 hover:bg-white/10 rounded-full"><Settings className="w-5 h-5"/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        <div className="flex bg-white p-1 rounded-lg shadow border border-slate-200">
                            {['dashboard','equipment','history'].map(t => (
                                <button key={t} type="button" onClick={()=>setActiveTab(t)} className={`flex-1 py-2 text-sm font-bold rounded ${activeTab===t ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>
                                    {t==='dashboard'?'ダッシュボード':t==='equipment'?'装備管理':'履歴'}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                <div className="grid grid-cols-3 gap-3">
                                    {[
                                        {id:'inspection', label:'点検', icon:<Search/>, color:'blue'},
                                        {id:'laundry', label:'洗濯', icon:<Droplets/>, color:'teal'},
                                        {id:'waterproof', label:'撥水', icon:<ShieldCheck/>, color:'indigo'}
                                    ].map(btn => (
                                        <button key={btn.id} type="button" onClick={() => { setSelectedLogType(btn.id); setIsLogModalOpen(true); }} className={`p-4 rounded-xl border flex flex-col items-center gap-2 transition-all ${status[btn.id] ? `bg-${btn.color}-50 border-${btn.color}-200` : 'bg-white shadow-sm hover:shadow-md'}`}>
                                            <div className={`p-2 rounded-full ${status[btn.id] ? `bg-${btn.color}-200 text-${btn.color}-700` : 'bg-slate-100 text-slate-400'}`}>{btn.icon}</div>
                                            <span className="text-xs font-bold">{btn.label}</span>
                                            {status[btn.id] && <CheckCircle2 className={`w-4 h-4 text-${btn.color}-500 absolute top-2 right-2`}/>}
                                        </button>
                                    ))}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Activity className="w-4 h-4"/> 現場活動リスク（累計）</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                            <div className="text-xs font-bold text-purple-700 mb-1 flex items-center gap-1"><Zap className="w-3 h-3"/> 化学物質</div>
                                            <div className="text-2xl font-bold text-slate-800">{formatDuration(exposureStats.chemicalDuration)}</div>
                                            <div className="text-xs text-slate-500 mt-1">{exposureStats.chemicalCount} 件</div>
                                        </div>
                                        <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                            <div className="text-xs font-bold text-orange-700 mb-1 flex items-center gap-1"><Flame className="w-3 h-3"/> 一般火災</div>
                                            <div className="text-2xl font-bold text-slate-800">{formatDuration(exposureStats.otherDuration)}</div>
                                            <div className="text-xs text-slate-500 mt-1">{exposureStats.otherCount} 件</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-slate-700 text-sm">装備の状態</h3>
                                        <button type="button" onClick={()=>setActiveTab('equipment')} className="text-xs text-blue-600">詳細 &rarr;</button>
                                    </div>
                                    {equipmentList.length === 0 ? <p className="text-xs text-slate-400 text-center py-4">装備がありません</p> : (
                                        <div className="space-y-2">
                                            {equipmentList.slice(0,3).map(eq => {
                                                const age = calculateAge(eq.deployDate);
                                                const isOld = age.years >= eq.lifespanYears;
                                                return (
                                                    <div key={eq.id} className="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100">
                                                        <div className="flex items-center gap-2">
                                                            {getEquipmentIcon(eq.type)}
                                                            <span className="text-sm font-bold text-slate-700">{eq.name}</span>
                                                        </div>
                                                        {isOld ? <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold">更新推奨</span> : <span className="text-[10px] text-slate-500">{age.years}年目</span>}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'equipment' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
                                <button type="button" onClick={()=>{resetEquipForm(); setIsEquipModalOpen(true);}} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><PlusCircle className="w-5 h-5"/> 装備を追加する</button>
                                <div className="space-y-3">
                                    {equipmentList.map(eq => {
                                        const age = calculateAge(eq.deployDate);
                                        const isOld = age.years >= eq.lifespanYears;
                                        return (
                                            <div key={eq.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
                                                {isOld && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 font-bold">耐用年数超過</div>}
                                                <div className="flex justify-between items-start">
                                                    <div className="flex gap-3">
                                                        <div className="p-3 bg-slate-100 rounded-lg h-fit">{getEquipmentIcon(eq.type, "w-6 h-6")}</div>
                                                        <div>
                                                            <div className="font-bold text-slate-800">{eq.name}</div>
                                                            <div className="text-xs text-slate-500 mt-1">
                                                                <p>配備: {eq.deployDate.toLocaleDateString()}</p>
                                                                <p>耐用: {eq.lifespanYears}年</p>
                                                                {eq.vendor && <p>業者: {eq.vendor}</p>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-xl font-bold text-slate-700">{age.years}<span className="text-xs font-normal">年</span>{age.months}<span className="text-xs font-normal">ヶ月</span></div>
                                                        <button type="button" onClick={()=>handleDeleteEquipment(eq.id)} className="mt-2 text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-bold text-slate-700">履歴一覧</h2>
                                    <button type="button" onClick={handleExportCSV} className="text-xs bg-green-600 text-white px-3 py-1.5 rounded flex items-center gap-1 shadow"><Download className="w-3 h-3"/> CSV出力</button>
                                </div>
                                <div className="space-y-3">
                                    {logs.map(log => (
                                        <div key={log.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="flex gap-3">
                                                <div className={`p-2 rounded-lg h-fit ${getTypeColor(log.type)}`}>{getTypeIcon(log.type)}</div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div className="font-bold text-slate-800 text-sm">{getTypeName(log.type)}</div>
                                                        <div className="text-xs text-slate-400">{log.date.toLocaleDateString()}</div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-1 mb-2">
                                                        {log.fireType && log.fireType !== 'none' && <span className={`text-[10px] px-1.5 py-0.5 rounded border ${getFireTypeColor(log.fireType)}`}>{getFireTypeName(log.fireType)}</span>}
                                                        {log.chemicalExposure && <span className="text-[10px] px-1.5 py-0.5 rounded border bg-red-50 text-red-600 border-red-200">化学曝露あり</span>}
                                                    </div>
                                                    {(log.incidentName || log.activityDurationMinutes > 0) && (
                                                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-600 mb-2">
                                                            {log.incidentName && <div><span className="font-bold">場所:</span> {log.incidentName}</div>}
                                                            {log.activityDurationMinutes > 0 && <div><span className="font-bold">活動:</span> {log.activityDurationMinutes}分</div>}
                                                        </div>
                                                    )}
                                                    {log.notes && <div className="text-xs text-slate-500 italic border-l-2 border-slate-300 pl-2">{log.notes}</div>}
                                                </div>
                                                <button type="button" onClick={()=>handleDeleteLog(log.id)} className="text-slate-300 hover:text-red-500 h-fit"><Trash2 className="w-4 h-4"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Modals */}
                    {isLogModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" onClick={(e)=>{if(e.target===e.currentTarget)setIsLogModalOpen(false)}}>
                            <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom-20 relative">
                                <button type="button" onClick={()=>setIsLogModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X className="w-5 h-5 text-slate-600"/></button>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold flex items-center gap-2">{getTypeIcon(selectedLogType, "text-orange-500")} {getTypeName(selectedLogType)}を記録</h3>
                                </div>
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                                        <h4 className="font-bold text-sm text-slate-700 flex gap-2"><Flame className="w-4 h-4 text-orange-500"/> 災害情報 (任意)</h4>
                                        <div className="grid grid-cols-3 gap-2">
                                            {['building','vehicle','chemical','other','training','none'].map(t => (
                                                <button key={t} type="button" onClick={()=>{setFireType(t); if(t==='chemical')setChemicalExposure(true);}} className={`text-xs py-2 rounded border font-bold ${fireType===t ? 'bg-slate-800 text-white' : 'bg-white text-slate-600'}`}>{getFireTypeName(t)}</button>
                                            ))}
                                        </div>
                                        <div className="space-y-2">
                                            <input type="text" placeholder="事案名・場所" className="w-full p-2 border rounded text-sm" value={incidentName} onChange={e=>setIncidentName(e.target.value)} />
                                            <div className="flex gap-2">
                                                <input type="number" placeholder="活動時間(分)" className="w-1/3 p-2 border rounded text-sm" value={activityDuration} onChange={e=>setActivityDuration(e.target.value)} />
                                                <input type="datetime-local" className="flex-1 p-2 border rounded text-sm" value={incidentDateStr} onChange={e=>setIncidentDateStr(e.target.value)} />
                                            </div>
                                        </div>
                                    </div>
                                    <label className={`flex items-center gap-3 p-4 border rounded-xl cursor-pointer ${chemicalExposure?'bg-red-50 border-red-200':'bg-white'}`}>
                                        <input type="checkbox" checked={chemicalExposure} onChange={e=>setChemicalExposure(e.target.checked)} className="w-5 h-5 text-red-600"/>
                                        <div className="text-sm"><span className="font-bold block">化学物質曝露の可能性</span><span className="text-xs text-slate-500">煙や汚染水に長時間接触した場合</span></div>
                                    </label>
                                    <div>
                                        <p className="text-sm font-bold mb-2">対象装備</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            {equipmentList.map(eq => (
                                                <div key={eq.id} onClick={()=>setSelectedEquipmentIds(prev=>prev.includes(eq.id)?prev.filter(id=>id!==eq.id):[...prev,eq.id])} className={`p-2 border rounded cursor-pointer text-xs flex items-center gap-2 ${selectedEquipmentIds.includes(eq.id)?'bg-orange-50 border-orange-500':'bg-white'}`}>
                                                    {getEquipmentIcon(eq.type)} {eq.name}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <textarea placeholder="備考" className="w-full p-3 border rounded-xl h-20 text-sm" value={logNotes} onChange={e=>setLogNotes(e.target.value)}></textarea>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={()=>setIsLogModalOpen(false)} className="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">キャンセル</button>
                                        <button type="button" onClick={handleAddLog} disabled={isSubmitting} className="flex-[2] py-3 bg-orange-600 text-white font-bold rounded-xl shadow-lg active:scale-95 flex justify-center items-center">{isSubmitting ? <Loader2 className="animate-spin"/> : '記録する'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isEquipModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" onClick={(e)=>{if(e.target===e.currentTarget)setIsEquipModalOpen(false)}}>
                            <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-20 relative">
                                <button type="button" onClick={()=>setIsEquipModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X className="w-5 h-5 text-slate-600"/></button>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold flex items-center gap-2"><PlusCircle className="text-slate-800"/> 装備追加</h3>
                                </div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500">装備名 <span className="text-red-500">*</span></label><input type="text" className="w-full p-3 border rounded-xl bg-slate-50" value={newEquipName} onChange={e=>setNewEquipName(e.target.value)} placeholder="例: 防火衣(メイン)"/></div>
                                    <div><label className="text-xs font-bold text-slate-500">種類</label><select className="w-full p-3 border rounded-xl bg-slate-50" value={newEquipType} onChange={e=>setNewEquipType(e.target.value)}><option value="helmet">ヘルメット</option><option value="jacket">防火衣(上)</option><option value="trousers">防火衣(下)</option><option value="boots">長靴</option><option value="gloves">手袋</option><option value="other">その他</option></select></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-slate-500">配備日</label><input type="date" className="w-full p-3 border rounded-xl bg-slate-50" value={newEquipDate} onChange={e=>setNewEquipDate(e.target.value)}/></div>
                                        <div><label className="text-xs font-bold text-slate-500">耐用年数</label><input type="number" className="w-full p-3 border rounded-xl bg-slate-50" value={newEquipLifespan} onChange={e=>setNewEquipLifespan(e.target.value)}/></div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-500">メーカー・業者</label><input type="text" className="w-full p-3 border rounded-xl bg-slate-50" value={newEquipVendor} onChange={e=>setNewEquipVendor(e.target.value)}/></div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={()=>setIsEquipModalOpen(false)} className="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">キャンセル</button>
                                        <button type="button" onClick={handleAddEquipment} disabled={isSubmitting} className="flex-[2] py-3 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 flex justify-center items-center">{isSubmitting ? <Loader2 className="animate-spin"/> : '追加する'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isProfileModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={(e)=>{if(e.target===e.currentTarget)setIsProfileModalOpen(false)}}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-in zoom-in relative">
                                <button type="button" onClick={()=>setIsProfileModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X className="w-5 h-5 text-slate-600"/></button>
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Settings/> 設定</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500">氏名</label><input type="text" className="w-full p-3 border rounded-xl" value={editUserName} onChange={e=>setEditUserName(e.target.value)} placeholder="氏名"/></div>
                                    <button type="button" onClick={handleResetAllData} className="w-full py-3 border border-red-200 text-red-600 rounded-xl font-bold flex items-center justify-center gap-2"><RefreshCw className="w-4 h-4"/> データ初期化</button>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={()=>setIsProfileModalOpen(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold">閉じる</button>
                                        <button type="button" onClick={handleSaveProfile} className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isManualModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4" onClick={(e)=>{if(e.target===e.currentTarget)setIsManualModalOpen(false)}}>
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 relative animate-in zoom-in">
                                <button type="button" onClick={()=>setIsManualModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full"><X className="w-5 h-5"/></button>
                                <div className="text-center py-8">
                                    <h3 className="text-xl font-bold mb-4">使い方ガイド</h3>
                                    <div className="mb-6">{manualSlides[manualPage].component}</div>
                                    <h4 className="font-bold mb-2">{manualSlides[manualPage].title}</h4>
                                    <p className="text-slate-600 mb-6 text-sm">{manualSlides[manualPage].description}</p>
                                    <div className="flex justify-between items-center px-4">
                                        <button type="button" onClick={()=>setManualPage(Math.max(0,manualPage-1))} disabled={manualPage===0} className="p-2 bg-slate-100 rounded-full disabled:opacity-50"><ChevronLeft/></button>
                                        <div className="flex gap-1">{manualSlides.map((_,i)=><div key={i} className={`w-2 h-2 rounded-full ${i===manualPage?'bg-orange-500':'bg-slate-300'}`}/>)}</div>
                                        <button type="button" onClick={()=>{if(manualPage<manualSlides.length-1)setManualPage(manualPage+1);else setIsManualModalOpen(false);}} className="px-4 py-2 bg-slate-800 text-white rounded-full text-sm font-bold flex items-center gap-1">{manualPage===manualSlides.length-1?'完了':'次へ'}<ChevronRight className="w-4 h-4"/></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ActivityMaintenanceApp />);
    </script>
</body>
</html>
