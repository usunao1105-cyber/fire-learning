<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>装備＆活動記録アプリ</title>
    
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel (ブラウザでReactを動かすため) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map (ライブラリの読み込み先定義) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* アニメーション用の追加スタイル */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoom-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .animate-in { animation-fill-mode: forwards; }
        .fade-in { animation-name: fade-in; }
        .slide-in-from-bottom-2 { animation-name: slide-up; }
        .slide-in-from-bottom-20 { animation-name: slide-up; }
        .zoom-in { animation-name: zoom-in; }
        .duration-300 { animation-duration: 300ms; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            ShieldCheck, Droplets, Search, History, PlusCircle, Calendar, 
            CheckCircle2, AlertCircle, Trash2, HardHat, Footprints, Shirt, 
            HandMetal, Settings, AlertTriangle, Clock, Flame, Activity, 
            FileText, Download, User as UserIcon, Edit3, ShoppingBag, Tag, 
            RotateCcw, RefreshCw, Zap, BookOpen, ChevronRight, ChevronLeft, X 
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            Timestamp, deleteDoc, doc, setDoc, getDoc, writeBatch 
        } from 'firebase/firestore';

        // --- Firebase Configuration ---
        // 【重要】ここにFirebaseコンソールから取得した設定を貼り付けてください
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // App IDの設定（通常は固定値あるいはURLパラメータ等から取得）
        const APP_IDENTIFIER = 'activity-maintenance-app';

        // Firebase初期化（設定がある場合のみ）
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn("Firebase設定が正しくありません。コード内のfirebaseConfigを編集してください。");
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        // --- Helper Functions ---
        const getMonthString = (date) => `${date.getFullYear()}年${date.getMonth() + 1}月`;

        const getTypeName = (type) => {
            switch (type) {
                case 'inspection': return '点検';
                case 'laundry': return '洗濯';
                case 'waterproof': return '撥水';
                default: return 'その他';
            }
        };

        const getFireTypeName = (type) => {
            switch (type) {
                case 'building': return '建物火災';
                case 'vehicle': return '車両火災';
                case 'chemical': return '化学火災';
                case 'other': return 'その他火災';
                case 'training': return '訓練';
                case 'none': return 'なし（定期）';
                default: return '未分類';
            }
        };

        const getFireTypeColor = (type) => {
            switch (type) {
                case 'chemical': return 'bg-purple-100 text-purple-700 border-purple-200';
                case 'vehicle': return 'bg-red-100 text-red-700 border-red-200';
                case 'building': return 'bg-orange-100 text-orange-700 border-orange-200';
                default: return 'bg-slate-100 text-slate-700 border-slate-200';
            }
        };

        const getEquipmentTypeName = (type) => {
            switch (type) {
                case 'helmet': return 'ヘルメット（頭部）';
                case 'jacket': return '防火衣・上（上体）';
                case 'trousers': return '防火衣・下（下肢）';
                case 'boots': return '長靴（足部）';
                case 'gloves': return '手袋（手部）';
                default: return 'その他装備';
            }
        };

        const getEquipmentIcon = (type, className = "w-5 h-5") => {
            switch (type) {
                case 'helmet': return <HardHat className={className} />;
                case 'jacket': return <Shirt className={className} />;
                case 'trousers': return <div className={`flex flex-col items-center justify-center ${className}`}><div className="w-3/4 h-1/2 border-2 border-current border-t-0 rounded-b-sm" /></div>;
                case 'boots': return <Footprints className={className} />;
                case 'gloves': return <HandMetal className={className} />;
                default: return <ShieldCheck className={className} />;
            }
        };

        const getTypeIcon = (type, className = "w-5 h-5") => {
            switch (type) {
                case 'inspection': return <Search className={className} />;
                case 'laundry': return <Droplets className={className} />;
                case 'waterproof': return <ShieldCheck className={className} />;
                default: return <div className={className} />;
            }
        };

        const getTypeColor = (type) => {
            switch (type) {
                case 'inspection': return 'bg-blue-100 text-blue-700 border-blue-200';
                case 'laundry': return 'bg-teal-100 text-teal-700 border-teal-200';
                case 'waterproof': return 'bg-indigo-100 text-indigo-700 border-indigo-200';
                default: return 'bg-gray-100 text-gray-700';
            }
        };

        const calculateAge = (date) => {
            const now = new Date();
            const diffTime = Math.abs(now.getTime() - date.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const years = Math.floor(diffDays / 365);
            const months = Math.floor((diffDays % 365) / 30);
            return { years, months };
        };

        const formatDuration = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            if (h > 0) return `${h}時間${m}分`;
            return `${m}分`;
        };

        const formatDateForInput = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date.getTime() - offset)).toISOString().slice(0, 16);
            return localISOTime;
        };

        // --- SVG Animation Components ---
        const GuideScene1 = () => (
            <svg viewBox="0 0 200 150" className="w-full h-auto rounded-xl bg-slate-50 border border-slate-200">
                <style>
                {`
                    @keyframes pulse-btn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); fill: #f97316; } }
                    @keyframes slide-in { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
                    @keyframes check-mark { 0% { stroke-dasharray: 0 100; } 100% { stroke-dasharray: 100 0; } }
                    .btn-anim { animation: pulse-btn 2s infinite ease-in-out; }
                    .modal-anim { animation: slide-in 0.5s ease-out forwards; }
                    .check-anim { stroke-dasharray: 100; stroke-dashoffset: 100; animation: check-mark 1s 1s forwards ease-out; }
                `}
                </style>
                <rect x="50" y="10" width="100" height="130" rx="8" fill="white" stroke="#94a3b8" strokeWidth="2" />
                <rect x="55" y="15" width="90" height="10" rx="2" fill="#e2e8f0" />
                <circle cx="75" cy="45" r="12" fill="#fed7aa" className="btn-anim" />
                <path d="M70 45 L73 48 L80 41" stroke="#c2410c" strokeWidth="2" fill="none" />
                <circle cx="100" cy="45" r="10" fill="#e2e8f0" />
                <circle cx="125" cy="45" r="10" fill="#e2e8f0" />
                <g className="modal-anim" style={{opacity: 0}}>
                    <rect x="60" y="70" width="80" height="60" rx="4" fill="white" stroke="#cbd5e1" strokeWidth="1" filter="url(#shadow)" />
                    <rect x="65" y="75" width="70" height="8" rx="2" fill="#ffedd5" /> 
                    <rect x="65" y="88" width="30" height="20" rx="2" fill="#f1f5f9" /> 
                    <rect x="100" y="88" width="30" height="20" rx="2" fill="#f1f5f9" /> 
                    <rect x="65" y="115" width="70" height="10" rx="2" fill="#f97316" /> 
                    <text x="75" y="123" fontSize="6" fill="white" fontWeight="bold">記録する</text>
                </g>
                <path d="M90 100 L95 105 L110 90" stroke="#16a34a" strokeWidth="4" fill="none" className="check-anim" strokeLinecap="round" strokeLinejoin="round" />
                <defs>
                    <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" floodOpacity="0.1" />
                    </filter>
                </defs>
            </svg>
        );

        const GuideScene2 = () => (
            <svg viewBox="0 0 200 150" className="w-full h-auto rounded-xl bg-slate-50 border border-slate-200">
                <style>
                {`
                    @keyframes grow-bar { 0% { width: 0; fill: #4ade80; } 50% { width: 60px; fill: #fbbf24; } 100% { width: 90px; fill: #ef4444; } }
                    @keyframes pop-alert { 0%, 80% { transform: scale(0); opacity: 0; } 90% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
                    .bar-anim { animation: grow-bar 3s infinite linear; }
                    .alert-anim { transform-origin: 170px 40px; animation: pop-alert 3s infinite ease-out; }
                `}
                </style>
                <rect x="20" y="30" width="160" height="50" rx="6" fill="white" stroke="#cbd5e1" strokeWidth="1" />
                <rect x="30" y="40" width="30" height="30" rx="4" fill="#f1f5f9" />
                <path d="M35 55 L45 55 M40 45 L40 65" stroke="#94a3b8" strokeWidth="2" />
                <rect x="70" y="40" width="80" height="6" rx="2" fill="#e2e8f0" />
                <text x="70" y="60" fontSize="8" fill="#64748b">経過年数</text>
                <rect x="70" y="65" width="100" height="8" rx="4" fill="#f1f5f9" />
                <rect x="70" y="65" width="0" height="8" rx="4" className="bar-anim" />
                <g className="alert-anim">
                    <circle cx="170" cy="40" r="10" fill="#ef4444" />
                    <text x="168" y="44" fontSize="12" fill="white" fontWeight="bold">!</text>
                </g>
                <text x="20" y="100" fontSize="10" fill="#475569" fontWeight="bold">装備の寿命を可視化！</text>
                <text x="20" y="115" fontSize="8" fill="#64748b">交換時期を逃しません。</text>
            </svg>
        );

        const GuideScene3 = () => (
            <svg viewBox="0 0 200 150" className="w-full h-auto rounded-xl bg-slate-50 border border-slate-200">
                <style>
                {`
                    @keyframes float-file { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
                    @keyframes arrow-down { 0% { transform: translateY(-10px); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(10px); opacity: 0; } }
                    .file-anim { animation: float-file 3s infinite ease-in-out; }
                    .arrow-anim { animation: arrow-down 2s infinite linear; }
                `}
                </style>
                <rect x="20" y="80" width="20" height="40" fill="#e2e8f0" rx="2" />
                <rect x="50" y="60" width="20" height="60" fill="#fed7aa" rx="2" />
                <rect x="80" y="40" width="20" height="80" fill="#fb923c" rx="2" />
                <path d="M20 120 L180 120" stroke="#cbd5e1" strokeWidth="2" />
                <g transform="translate(130, 30)" className="file-anim">
                    <path d="M0 0 L30 0 L40 10 L40 50 L0 50 Z" fill="#10b981" />
                    <path d="M30 0 L30 10 L40 10" fill="#047857" />
                    <text x="8" y="35" fontSize="12" fill="white" fontWeight="bold">CSV</text>
                </g>
                <g transform="translate(150, 90)" className="arrow-anim">
                    <path d="M0 0 L0 15 M-5 10 L0 15 L5 10" stroke="#059669" strokeWidth="3" fill="none" strokeLinecap="round" strokeLinejoin="round" />
                </g>
                <text x="20" y="25" fontSize="10" fill="#475569" fontWeight="bold">データを分析・報告</text>
                <text x="20" y="40" fontSize="8" fill="#64748b">活動記録をCSV出力して活用。</text>
            </svg>
        );

        // --- Main App Component ---
        const ActivityMaintenanceApp = () => {
            const [user, setUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [logs, setLogs] = useState([]);
            const [equipmentList, setEquipmentList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [errorMsg, setErrorMsg] = useState(null);

            // Log Modal State
            const [isLogModalOpen, setIsLogModalOpen] = useState(false);
            const [selectedLogType, setSelectedLogType] = useState('inspection');
            const [logNotes, setLogNotes] = useState('');
            const [chemicalExposure, setChemicalExposure] = useState(false);
            const [selectedEquipmentIds, setSelectedEquipmentIds] = useState([]);
            
            // New Log Fields
            const [fireType, setFireType] = useState('none');
            const [activityDuration, setActivityDuration] = useState(''); 
            const [incidentDateStr, setIncidentDateStr] = useState(''); 
            const [incidentName, setIncidentName] = useState('');

            // Equipment Modal State
            const [isEquipModalOpen, setIsEquipModalOpen] = useState(false);
            const [newEquipName, setNewEquipName] = useState('');
            const [newEquipType, setNewEquipType] = useState('jacket');
            const [newEquipDate, setNewEquipDate] = useState('');
            const [newEquipLifespan, setNewEquipLifespan] = useState(3); 
            const [newEquipVendor, setNewEquipVendor] = useState(''); 
            const [newEquipSpec, setNewEquipSpec] = useState('');

            // Profile Modal State
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [editUserName, setEditUserName] = useState('');

            // Manual Modal State
            const [isManualModalOpen, setIsManualModalOpen] = useState(false);
            const [manualPage, setManualPage] = useState(0);

            // Auth & Data Fetching
            useEffect(() => {
                if (!auth) {
                    setLoading(false);
                    setErrorMsg("Firebase設定が見つかりません。HTMLファイル内のfirebaseConfigを設定してください。");
                    return;
                }

                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Auth Error", error);
                            setErrorMsg("認証エラーが発生しました: " + error.message);
                        });
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // Data Listeners
            useEffect(() => {
                if (!user || !db) return;

                // Logs
                const logsQuery = query(
                    collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs'),
                    orderBy('date', 'desc')
                );
                const unsubLogs = onSnapshot(logsQuery, (snapshot) => {
                    const fetchedLogs = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date?.toDate ? data.date.toDate() : new Date(),
                            incidentDate: data.incidentDate?.toDate ? data.incidentDate.toDate() : undefined,
                        };
                    });
                    setLogs(fetchedLogs);
                });

                // Equipment
                const equipQuery = query(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment'));
                const unsubEquip = onSnapshot(equipQuery, (snapshot) => {
                    const fetchedEquip = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            deployDate: data.deployDate?.toDate ? data.deployDate.toDate() : new Date(),
                        };
                    });
                    // Sort logic
                    const typeOrder = { helmet: 1, jacket: 2, trousers: 3, boots: 4, gloves: 5, other: 6 };
                    fetchedEquip.sort((a, b) => (typeOrder[a.type] || 99) - (typeOrder[b.type] || 99));
                    setEquipmentList(fetchedEquip);
                    setLoading(false);
                });

                // Profile
                const profileRef = doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'settings', 'profile');
                getDoc(profileRef).then(docSnap => {
                    if (docSnap.exists()) {
                        setUserName(docSnap.data().displayName || '');
                    }
                });

                return () => {
                    unsubLogs();
                    unsubEquip();
                };
            }, [user]);

            // Handlers
            const handleSaveProfile = async () => {
                if (!user) return;
                await setDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'settings', 'profile'), {
                    displayName: editUserName
                });
                setUserName(editUserName);
                setIsProfileModalOpen(false);
            };

            const handleResetAllData = async () => {
                if (!user || !window.confirm('【警告】本当に全てのデータ（履歴・装備）を削除して初期化しますか？この操作は取り消せません。')) return;
                setLoading(true);
                try {
                    const batch = writeBatch(db);
                    logs.forEach(log => batch.delete(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs', log.id)));
                    equipmentList.forEach(eq => batch.delete(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment', eq.id)));
                    await batch.commit();
                    alert('データを初期化しました。');
                } catch (error) {
                    console.error("Error resetting data:", error);
                    alert('初期化中にエラーが発生しました。');
                } finally {
                    setLoading(false);
                }
            };

            const handleAddLog = async () => {
                if (!user) return;
                const logData = {
                    type: selectedLogType,
                    date: Timestamp.now(),
                    notes: logNotes,
                    chemicalExposure: chemicalExposure,
                    targetEquipmentIds: selectedEquipmentIds,
                    fireType: fireType,
                    activityDurationMinutes: activityDuration ? parseInt(activityDuration) : 0,
                    incidentName: incidentName,
                };
                if (incidentDateStr) {
                    logData.incidentDate = Timestamp.fromDate(new Date(incidentDateStr));
                }
                await addDoc(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs'), logData);
                setIsLogModalOpen(false);
                resetLogForm();
            };

            const handleAddEquipment = async () => {
                if (!user) return;
                const deployDate = new Date(newEquipDate || Date.now());
                await addDoc(collection(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment'), {
                    name: newEquipName,
                    type: newEquipType,
                    deployDate: Timestamp.fromDate(deployDate),
                    lifespanYears: Number(newEquipLifespan),
                    vendor: newEquipVendor,
                    specification: newEquipSpec,
                });
                setIsEquipModalOpen(false);
                resetEquipForm();
            };

            const handleDeleteLog = async (id) => {
                if (!user || !window.confirm('この記録を削除してもよろしいですか？')) return;
                await deleteDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'maintenance_logs', id));
            };

            const handleDeleteEquipment = async (id) => {
                if (!user || !window.confirm('この装備を削除しますか？')) return;
                await deleteDoc(doc(db, 'artifacts', APP_IDENTIFIER, 'users', user.uid, 'equipment', id));
            };

            const handleExportCSV = () => {
                if (logs.length === 0) {
                    alert("エクスポートするデータがありません");
                    return;
                }
                const header = [
                    "氏名", "記録日時", "メンテナンス種別", "火災・災害種別", 
                    "事案名・場所", "発生日時", "活動時間(分)", "化学物質曝露", 
                    "対象装備(メーカー・業者)", "備考"
                ].join(",");

                const rows = logs.map(log => {
                    const equipNames = log.targetEquipmentIds
                        .map(id => {
                            const e = equipmentList.find(e => e.id === id);
                            if (!e) return "不明";
                            return e.vendor ? `${e.name}(${e.vendor})` : e.name;
                        })
                        .join(" / ");
                    const safeNotes = `"${(log.notes || "").replace(/"/g, '""')}"`;
                    const safeIncidentName = `"${(log.incidentName || "").replace(/"/g, '""')}"`;
                    const safeEquip = `"${equipNames}"`;
                    const safeUserName = `"${userName || "未登録"}"`;

                    return [
                        safeUserName,
                        log.date.toLocaleString(),
                        getTypeName(log.type),
                        getFireTypeName(log.fireType || 'none'),
                        safeIncidentName,
                        log.incidentDate ? log.incidentDate.toLocaleString() : "-",
                        log.activityDurationMinutes || 0,
                        log.chemicalExposure ? "あり" : "なし",
                        safeEquip,
                        safeNotes
                    ].join(",");
                });

                const csvContent = "\uFEFF" + [header, ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `活動記録_${userName || 'user'}_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const resetLogForm = () => {
                setLogNotes('');
                setChemicalExposure(false);
                setSelectedEquipmentIds([]);
                setFireType('none');
                setActivityDuration('');
                setIncidentDateStr('');
                setIncidentName('');
            };

            const resetEquipForm = () => {
                setNewEquipName('');
                setNewEquipType('jacket');
                setNewEquipDate('');
                setNewEquipLifespan(3);
                setNewEquipVendor('');
                setNewEquipSpec('');
            };

            const openLogModal = (type) => {
                setSelectedLogType(type);
                setSelectedEquipmentIds(equipmentList.map(e => e.id));
                setFireType('none');
                setIncidentDateStr(formatDateForInput(new Date()));
                setIsLogModalOpen(true);
            };

            const openProfileModal = () => {
                setEditUserName(userName);
                setIsProfileModalOpen(true);
            };

            // Stats
            const currentMonth = new Date();
            const currentMonthLogs = logs.filter(log => 
                log.date.getMonth() === currentMonth.getMonth() && 
                log.date.getFullYear() === currentMonth.getFullYear()
            );
            const status = {
                inspection: currentMonthLogs.some(l => l.type === 'inspection'),
                laundry: currentMonthLogs.some(l => l.type === 'laundry'),
                waterproof: currentMonthLogs.some(l => l.type === 'waterproof'),
            };
            const exposureStats = logs.reduce((acc, log) => {
                if (log.fireType && log.fireType !== 'none' && log.fireType !== 'training') {
                    if (log.fireType === 'chemical' || log.chemicalExposure) {
                        acc.chemicalCount += 1;
                        acc.chemicalDuration += (log.activityDurationMinutes || 0);
                    } else {
                        acc.otherCount += 1;
                        acc.otherDuration += (log.activityDurationMinutes || 0);
                    }
                }
                return acc;
            }, { chemicalCount: 0, chemicalDuration: 0, otherCount: 0, otherDuration: 0 });

            // Manual content
            const manualSlides = [
                {
                    title: "1. 活動を記録する",
                    description: "「点検」「洗濯」「撥水」ボタンから記録を開始します。火災種別や活動時間を入れると、リスク管理データとして蓄積されます。",
                    component: <GuideScene1 />
                },
                {
                    title: "2. 装備を管理する",
                    description: "装備品（防火衣、ヘルメットなど）を登録すると、使用年数が自動計算されます。耐用年数が近づくとアラートでお知らせします。",
                    component: <GuideScene2 />
                },
                {
                    title: "3. データを活用する",
                    description: "蓄積されたデータは「履歴」タブからCSVファイルとしてダウンロード可能。活動報告書や個人の健康管理手帳の作成に役立ちます。",
                    component: <GuideScene3 />
                }
            ];

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        {errorMsg ? (
                            <div className="text-red-500 bg-white p-4 rounded-xl shadow border border-red-200">
                                <p className="font-bold mb-2">エラーが発生しました</p>
                                <p className="text-sm">{errorMsg}</p>
                            </div>
                        ) : (
                            <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-500"></div>
                        )}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 font-sans text-slate-800 pb-20">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-slate-900 via-blue-900 to-indigo-900 text-white p-4 shadow-xl sticky top-0 z-20 border-b border-indigo-800">
                        <div className="max-w-md mx-auto flex items-center justify-between">
                            <div>
                                <div className="flex items-center gap-2">
                                    <div className="bg-orange-500 p-1 rounded"><ShieldCheck className="w-5 h-5 text-white" /></div>
                                    <h1 className="text-lg font-bold tracking-tight">装備＆活動記録</h1>
                                </div>
                                {userName && <div className="text-xs text-indigo-200 mt-1 flex items-center gap-1 font-medium"><UserIcon className="w-3 h-3" />{userName}</div>}
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="text-xs bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-white border border-white/10 shadow-sm">{getMonthString(currentMonth)}</div>
                                <button onClick={() => { setManualPage(0); setIsManualModalOpen(true); }} className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-all shadow-sm active:scale-95"><BookOpen className="w-5 h-5 text-white" /></button>
                                <button onClick={openProfileModal} className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-all shadow-sm active:scale-95"><Settings className="w-5 h-5 text-white" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        {/* Tabs */}
                        <div className="flex bg-white p-1.5 rounded-xl shadow-md border border-slate-200/60">
                            <button onClick={() => setActiveTab('dashboard')} className={`flex-1 py-2.5 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 ${activeTab === 'dashboard' ? 'bg-gradient-to-b from-orange-50 to-orange-100 text-orange-700 shadow-sm border border-orange-200' : 'text-slate-500 hover:bg-slate-50'}`}>ダッシュボード</button>
                            <button onClick={() => setActiveTab('equipment')} className={`flex-1 py-2.5 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 ${activeTab === 'equipment' ? 'bg-gradient-to-b from-blue-50 to-blue-100 text-blue-700 shadow-sm border border-blue-200' : 'text-slate-500 hover:bg-slate-50'}`}>装備管理</button>
                            <button onClick={() => setActiveTab('history')} className={`flex-1 py-2.5 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 ${activeTab === 'history' ? 'bg-gradient-to-b from-slate-100 to-slate-200 text-slate-800 shadow-sm border border-slate-300' : 'text-slate-500 hover:bg-slate-50'}`}>履歴</button>
                        </div>

                        {/* Dashboard */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <div className="grid grid-cols-3 gap-3">
                                    <button onClick={() => openLogModal('inspection')} className={`relative overflow-hidden p-3 rounded-2xl border transition-all duration-300 group ${status.inspection ? 'bg-gradient-to-br from-blue-50 to-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-white border-slate-200 shadow hover:shadow-lg hover:-translate-y-1'}`}>
                                        <div className="flex flex-col items-center justify-center gap-2 z-10 relative">
                                            <div className={`p-3 rounded-2xl transition-colors ${status.inspection ? 'bg-blue-500 text-white shadow-blue-200 shadow-lg' : 'bg-slate-100 text-slate-400'}`}><Search className="w-6 h-6" /></div>
                                            <span className="text-xs font-bold text-slate-600">点検</span>
                                        </div>
                                        {status.inspection && <div className="absolute top-2 right-2 animate-in zoom-in"><CheckCircle2 className="w-5 h-5 text-blue-500 drop-shadow-sm" /></div>}
                                    </button>
                                    <button onClick={() => openLogModal('laundry')} className={`relative overflow-hidden p-3 rounded-2xl border transition-all duration-300 group ${status.laundry ? 'bg-gradient-to-br from-teal-50 to-white border-teal-200 shadow-md ring-1 ring-teal-100' : 'bg-white border-slate-200 shadow hover:shadow-lg hover:-translate-y-1'}`}>
                                        <div className="flex flex-col items-center justify-center gap-2 z-10 relative">
                                            <div className={`p-3 rounded-2xl transition-colors ${status.laundry ? 'bg-teal-500 text-white shadow-teal-200 shadow-lg' : 'bg-slate-100 text-slate-400'}`}><Droplets className="w-6 h-6" /></div>
                                            <span className="text-xs font-bold text-slate-600">洗濯</span>
                                        </div>
                                        {status.laundry && <div className="absolute top-2 right-2 animate-in zoom-in"><CheckCircle2 className="w-5 h-5 text-teal-500 drop-shadow-sm" /></div>}
                                    </button>
                                    <button onClick={() => openLogModal('waterproof')} className={`relative overflow-hidden p-3 rounded-2xl border transition-all duration-300 group ${status.waterproof ? 'bg-gradient-to-br from-indigo-50 to-white border-indigo-200 shadow-md ring-1 ring-indigo-100' : 'bg-white border-slate-200 shadow hover:shadow-lg hover:-translate-y-1'}`}>
                                        <div className="flex flex-col items-center justify-center gap-2 z-10 relative">
                                            <div className={`p-3 rounded-2xl transition-colors ${status.waterproof ? 'bg-indigo-500 text-white shadow-indigo-200 shadow-lg' : 'bg-slate-100 text-slate-400'}`}><ShieldCheck className="w-6 h-6" /></div>
                                            <span className="text-xs font-bold text-slate-600">撥水</span>
                                        </div>
                                        {status.waterproof && <div className="absolute top-2 right-2 animate-in zoom-in"><CheckCircle2 className="w-5 h-5 text-indigo-500 drop-shadow-sm" /></div>}
                                    </button>
                                </div>

                                {/* Risk Dashboard */}
                                <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden relative">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-orange-100/50 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                                    <div className="bg-slate-50/80 backdrop-blur px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            <div className="bg-red-500 p-1 rounded text-white"><Activity className="w-3.5 h-3.5" /></div>現場活動・曝露リスク
                                        </h3>
                                    </div>
                                    <div className="p-5 grid grid-cols-2 gap-4 relative z-10">
                                        <div className="bg-gradient-to-br from-purple-50 to-white rounded-xl p-4 border border-purple-100 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="flex items-center gap-2 mb-3">
                                                <div className="bg-purple-100 p-1.5 rounded-lg text-purple-600"><Zap className="w-4 h-4" /></div>
                                                <span className="text-xs font-bold text-purple-900">化学物質リスク</span>
                                            </div>
                                            <div className="flex items-baseline gap-1 mb-1">
                                                <span className="text-3xl font-extrabold text-slate-800 tracking-tight">{formatDuration(exposureStats.chemicalDuration).replace(/時間|分/g, '')}</span>
                                                <span className="text-xs font-bold text-slate-500">{formatDuration(exposureStats.chemicalDuration).includes('時間') ? '時間' : '分'}</span>
                                            </div>
                                            <div className="text-xs text-slate-500 flex justify-between items-center mt-2 pt-2 border-t border-purple-100">
                                                <span className="font-medium">累計件数</span>
                                                <span className="font-bold bg-white px-2 py-0.5 rounded-full border border-purple-100 text-purple-700 shadow-sm">{exposureStats.chemicalCount}件</span>
                                            </div>
                                        </div>
                                        <div className="bg-gradient-to-br from-orange-50 to-white rounded-xl p-4 border border-orange-100 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="flex items-center gap-2 mb-3">
                                                <div className="bg-orange-100 p-1.5 rounded-lg text-orange-600"><Flame className="w-4 h-4" /></div>
                                                <span className="text-xs font-bold text-orange-900">一般火災</span>
                                            </div>
                                            <div className="flex items-baseline gap-1 mb-1">
                                                <span className="text-2xl font-extrabold text-slate-800 tracking-tight">{formatDuration(exposureStats.otherDuration).replace(/時間|分/g, '')}</span>
                                                <span className="text-xs font-bold text-slate-500">{formatDuration(exposureStats.otherDuration).includes('時間') ? '時間' : '分'}</span>
                                            </div>
                                            <div className="text-xs text-slate-500 flex justify-between items-center mt-2 pt-2 border-t border-orange-100">
                                                <span className="font-medium">累計件数</span>
                                                <span className="font-bold bg-white px-2 py-0.5 rounded-full border border-orange-100 text-orange-700 shadow-sm">{exposureStats.otherCount}件</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Equipment Summary */}
                                <div>
                                    <div className="flex justify-between items-center mb-3 px-1">
                                        <h3 className="font-bold text-slate-700 text-sm">装備の状態</h3>
                                        <button onClick={() => setActiveTab('equipment')} className="text-xs text-indigo-600 font-bold hover:underline">すべて見る &rarr;</button>
                                    </div>
                                    {equipmentList.length === 0 ? (
                                        <div className="text-center p-6 bg-white border-2 border-dashed border-slate-200 rounded-xl text-slate-400">
                                            <p className="text-sm">装備が登録されていません</p>
                                            <button onClick={() => setIsEquipModalOpen(true)} className="mt-2 text-sm text-indigo-600 font-bold hover:underline">+ 装備を追加する</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {equipmentList.slice(0, 3).map(item => {
                                                const age = calculateAge(item.deployDate);
                                                const isOld = age.years >= item.lifespanYears;
                                                const isNear = age.years >= item.lifespanYears - 1;
                                                return (
                                                    <div key={item.id} className="bg-white p-3 rounded-xl border border-slate-100 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow">
                                                        <div className="flex items-center gap-3">
                                                            <div className="p-2.5 bg-slate-50 rounded-lg text-slate-500 border border-slate-100">{getEquipmentIcon(item.type)}</div>
                                                            <div>
                                                                <div className="font-bold text-sm text-slate-800">{item.name}</div>
                                                                {item.vendor && <div className="text-[10px] text-slate-500 font-bold flex items-center gap-1"><ShoppingBag className="w-3 h-3" />{item.vendor}</div>}
                                                            </div>
                                                        </div>
                                                        {isOld ? (
                                                            <span className="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-1 rounded-md flex items-center gap-1 border border-red-200"><AlertTriangle className="w-3 h-3" />更新推奨</span>
                                                        ) : isNear ? (
                                                            <span className="text-[10px] font-bold bg-yellow-50 text-yellow-700 px-2 py-1 rounded-md border border-yellow-200">更新間近</span>
                                                        ) : (
                                                            <span className="text-[10px] font-bold bg-green-50 text-green-600 px-2 py-1 rounded-md border border-green-200">良好 ({age.years}年目)</span>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Equipment Tab */}
                        {activeTab === 'equipment' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2"><Settings className="w-5 h-5 text-indigo-500" />装備品リスト</h2>
                                    <button onClick={() => setIsEquipModalOpen(true)} className="bg-gradient-to-r from-slate-800 to-slate-900 text-white text-xs font-bold px-4 py-2 rounded-full flex items-center gap-1 hover:shadow-lg transition-all active:scale-95"><PlusCircle className="w-4 h-4" />追加</button>
                                </div>
                                <div className="space-y-3">
                                    {equipmentList.map(item => {
                                        const age = calculateAge(item.deployDate);
                                        const isOld = age.years >= item.lifespanYears;
                                        const isNear = !isOld && (age.years >= item.lifespanYears - 1);
                                        return (
                                            <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all relative overflow-hidden group">
                                                {isOld && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg shadow-sm z-10">耐用年数超過</div>}
                                                <div className="flex items-start justify-between relative z-0">
                                                    <div className="flex gap-4">
                                                        <div className={`p-3 rounded-xl h-fit border ${isOld ? 'bg-red-50 text-red-500 border-red-100' : 'bg-slate-50 text-slate-600 border-slate-100'}`}>{getEquipmentIcon(item.type, "w-6 h-6")}</div>
                                                        <div>
                                                            <h3 className="font-bold text-slate-800 text-base">{item.name}</h3>
                                                            <div className="text-xs text-slate-500 mt-1 space-y-1">
                                                                <p className="flex items-center gap-1"><span className="w-1 h-1 bg-slate-300 rounded-full"></span> 種類: {getEquipmentTypeName(item.type)}</p>
                                                                <p className="flex items-center gap-1"><span className="w-1 h-1 bg-slate-300 rounded-full"></span> 配備: {item.deployDate.toLocaleDateString()}</p>
                                                                <p className="flex items-center gap-1"><span className="w-1 h-1 bg-slate-300 rounded-full"></span> 耐用: {item.lifespanYears}年</p>
                                                            </div>
                                                            {(item.vendor || item.specification) && (
                                                                <div className="mt-3 pt-2 border-t border-slate-100 text-xs text-slate-600 space-y-1.5">
                                                                    {item.vendor && <div className="flex items-center gap-1.5"><ShoppingBag className="w-3.5 h-3.5 text-indigo-400" /><span className="font-bold text-slate-700">業者:</span> {item.vendor}</div>}
                                                                    {item.specification && <div className="flex items-center gap-1.5"><Tag className="w-3.5 h-3.5 text-indigo-400" /><span className="font-bold text-slate-700">仕様:</span> {item.specification}</div>}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="text-right flex flex-col items-end h-full justify-between">
                                                        <div>
                                                            <div className="text-2xl font-extrabold text-slate-700 tracking-tight">{age.years}<span className="text-sm font-normal text-slate-400 ml-0.5">年</span>{age.months}<span className="text-sm font-normal text-slate-400 ml-0.5">ヶ月</span></div>
                                                            <p className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">経過時間</p>
                                                        </div>
                                                        <button onClick={() => handleDeleteEquipment(item.id)} className="mt-4 text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all"><Trash2 className="w-4 h-4" /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* History Tab */}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2"><History className="w-5 h-5 text-indigo-500" />履歴一覧</h2>
                                    <button onClick={handleExportCSV} className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white text-xs font-bold px-4 py-2 rounded-full flex items-center gap-1 hover:shadow-lg transition-all active:scale-95 border border-teal-400"><Download className="w-4 h-4" />CSV出力</button>
                                </div>
                                {logs.length === 0 ? (
                                    <div className="text-center py-10 text-slate-400 bg-white rounded-xl border-2 border-dashed border-slate-200"><p>記録はまだありません</p></div>
                                ) : (
                                    <div className="space-y-3">
                                        {logs.map((log) => (
                                            <div key={log.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start hover:shadow-md transition-all">
                                                <div className="flex gap-4 w-full">
                                                    <div className={`mt-1 p-2.5 rounded-xl h-fit border ${getTypeColor(log.type).replace('bg-', 'bg-opacity-20 ')}`}>{getTypeIcon(log.type)}</div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                <span className="font-bold text-slate-800 text-sm">{getTypeName(log.type)}</span>
                                                                {log.fireType && log.fireType !== 'none' && (
                                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold border shadow-sm flex items-center gap-1 ${getFireTypeColor(log.fireType)}`}>
                                                                        {getFireTypeName(log.fireType)}
                                                                        {(log.activityDurationMinutes || 0) > 0 && ` ${formatDuration(log.activityDurationMinutes)}`}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <span className="text-xs text-slate-400 whitespace-nowrap font-mono">{log.date.toLocaleDateString()}</span>
                                                        </div>
                                                        {(log.incidentName || log.incidentDate) && (
                                                            <div className="bg-slate-50 p-2.5 rounded-lg mb-2 border border-slate-200/60 text-xs">
                                                                {log.incidentName && <div className="font-bold text-slate-700 mb-1 flex items-center gap-1"><FileText className="w-3 h-3 text-slate-400" />{log.incidentName}</div>}
                                                                {log.incidentDate && <div className="text-slate-500 flex items-center gap-1 font-mono"><Calendar className="w-3 h-3" />発生: {log.incidentDate.toLocaleString([], {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</div>}
                                                            </div>
                                                        )}
                                                        {log.targetEquipmentIds && log.targetEquipmentIds.length > 0 && (
                                                            <div className="flex flex-wrap gap-1.5 mb-2">
                                                                {log.targetEquipmentIds.map(eqId => {
                                                                    const eq = equipmentList.find(e => e.id === eqId);
                                                                    return eq ? (
                                                                        <span key={eqId} className="inline-flex items-center gap-1 text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full border border-slate-200 font-medium">{getEquipmentIcon(eq.type, "w-3 h-3")}{eq.name}</span>
                                                                    ) : null;
                                                                })}
                                                            </div>
                                                        )}
                                                        {log.notes && <div className="text-xs text-slate-600 border-l-2 border-indigo-200 pl-3 py-1 mt-1 italic bg-slate-50/50 rounded-r">{log.notes}</div>}
                                                    </div>
                                                </div>
                                                <button onClick={() => handleDeleteLog(log.id)} className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 ml-1 rounded-full transition-all"><Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Modals */}
                        {isLogModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                                <div className="bg-white w-full max-w-md sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-20 fade-in duration-300 max-h-[90vh] overflow-y-auto border border-white/20">
                                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800">{getTypeIcon(selectedLogType, "w-7 h-7 text-orange-500")}{getTypeName(selectedLogType)}を記録</h3>
                                    <div className="space-y-6">
                                        <div className="bg-gradient-to-b from-slate-50 to-white p-4 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                            <h4 className="font-bold text-sm text-slate-700 flex items-center gap-2 pb-2 border-b border-slate-100"><div className="bg-orange-100 p-1 rounded-md text-orange-600"><Flame className="w-4 h-4" /></div>災害・活動詳細</h4>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-2 pl-1">事案種別（火災の場合）</label>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {['building', 'vehicle', 'chemical', 'other', 'training', 'none'].map(type => (
                                                        <button key={type} onClick={() => { setFireType(type); if(type==='chemical') setChemicalExposure(true); }} className={`text-xs py-2.5 rounded-xl border font-bold transition-all shadow-sm active:scale-95 ${fireType === type ? 'bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>{getFireTypeName(type)}</button>
                                                    ))}
                                                </div>
                                            </div>
                                            {fireType !== 'none' && (
                                                <div className="animate-in fade-in slide-in-from-top-2 space-y-4 pt-2">
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1 pl-1">事案名・活動場所</label><input type="text" value={incidentName} onChange={(e) => setIncidentName(e.target.value)} placeholder="例：〇〇町化学工場火災" className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm bg-white" /></div>
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1 pl-1">災害発生日時</label><input type="datetime-local" value={incidentDateStr} onChange={(e) => setIncidentDateStr(e.target.value)} className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm bg-white font-mono" /></div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1 pl-1">活動時間（現場滞在時間）</label>
                                                        <div className="flex items-center gap-2">
                                                            <div className="relative flex-1"><Clock className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" /><input type="number" min="0" value={activityDuration} onChange={(e) => setActivityDuration(e.target.value)} placeholder="分" className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-bold bg-white" /></div>
                                                            <span className="text-sm font-bold text-slate-600">分間</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <label className={`flex items-center gap-3 p-4 border rounded-2xl cursor-pointer transition-all ${chemicalExposure ? 'bg-red-50 border-red-200 shadow-sm' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                            <div className="relative flex items-center"><input type="checkbox" checked={chemicalExposure} onChange={(e) => setChemicalExposure(e.target.checked)} className="peer w-6 h-6 text-red-600 rounded focus:ring-red-500 border-slate-300" /></div>
                                            <div className="flex-1"><span className={`font-bold block text-sm ${chemicalExposure ? 'text-red-800' : 'text-slate-700'}`}>化学物質曝露の可能性あり</span><span className="text-red-600 text-xs mt-0.5">煙や汚染水に長時間接触した場合はチェック</span></div>
                                        </label>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-2 pl-1">メンテナンス対象（部位選択）</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {equipmentList.map(eq => {
                                                    const isSelected = selectedEquipmentIds.includes(eq.id);
                                                    return (
                                                        <div key={eq.id} onClick={() => { setSelectedEquipmentIds(prev => prev.includes(eq.id) ? prev.filter(id => id !== eq.id) : [...prev, eq.id]); }} className={`p-3 rounded-xl border cursor-pointer flex items-center gap-2 transition-all shadow-sm active:scale-95 ${isSelected ? 'bg-orange-50 border-orange-500 ring-1 ring-orange-500' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                                            <div className={isSelected ? 'text-orange-600' : 'text-slate-400'}>{getEquipmentIcon(eq.type)}</div>
                                                            <div className="min-w-0"><div className={`text-xs font-bold truncate ${isSelected ? 'text-orange-900' : 'text-slate-600'}`}>{eq.name}</div></div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1 pl-1">備考</label><textarea value={logNotes} onChange={(e) => setLogNotes(e.target.value)} placeholder="例：南側からの活動で煙を多く吸った、など" className="w-full border-slate-300 rounded-2xl shadow-sm focus:border-orange-500 focus:ring-orange-500 p-3 border min-h-[80px] bg-white text-sm" /></div>
                                        <div className="flex gap-3 pt-4 border-t border-slate-100">
                                            <button onClick={resetLogForm} className="p-3 text-slate-400 hover:text-slate-600 rounded-xl hover:bg-slate-100 transition-colors" title="入力をリセット"><RotateCcw className="w-5 h-5" /></button>
                                            <button onClick={() => setIsLogModalOpen(false)} className="flex-1 py-3.5 text-slate-600 font-bold bg-slate-100 rounded-xl hover:bg-slate-200 transition-all">キャンセル</button>
                                            <button onClick={handleAddLog} className="flex-[2] py-3.5 text-white font-bold bg-gradient-to-r from-orange-500 to-red-600 rounded-xl hover:shadow-lg hover:shadow-orange-200 transition-all shadow-md active:scale-95">記録する</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isEquipModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                                <div className="bg-white w-full max-w-md sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-20 fade-in duration-300 border border-white/20">
                                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800"><PlusCircle className="w-7 h-7 text-indigo-500" />新しい装備を追加</h3>
                                    <div className="space-y-4">
                                        <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">装備名</label><input type="text" value={newEquipName} onChange={(e) => setNewEquipName(e.target.value)} placeholder="例：メイン防火衣" className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50" /></div>
                                        <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">購入業者・メーカー</label><input type="text" value={newEquipVendor} onChange={(e) => setNewEquipVendor(e.target.value)} placeholder="例：A社、B代理店" className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50" /></div>
                                        <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">仕様・型番（備考）</label><input type="text" value={newEquipSpec} onChange={(e) => setNewEquipSpec(e.target.value)} placeholder="例：2024年モデル、アラミド系" className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50" /></div>
                                        <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">種類（部位）</label><select value={newEquipType} onChange={(e) => setNewEquipType(e.target.value)} className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50"><option value="helmet">ヘルメット（頭部）</option><option value="jacket">防火衣・上（上体）</option><option value="trousers">防火衣・下（下肢）</option><option value="boots">長靴（足部）</option><option value="gloves">手袋（手部）</option><option value="other">その他</option></select></div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">配備年月日</label><input type="date" value={newEquipDate} onChange={(e) => setNewEquipDate(e.target.value)} className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50 font-mono" /></div>
                                            <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">耐用年数(年)</label><input type="number" min="1" max="10" value={newEquipLifespan} onChange={(e) => setNewEquipLifespan(Number(e.target.value))} className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50/50" /></div>
                                        </div>
                                        <div className="flex gap-3 pt-6 border-t border-slate-100">
                                            <button onClick={resetEquipForm} className="p-3 text-slate-400 hover:text-slate-600 rounded-xl hover:bg-slate-100 transition-colors" title="入力をリセット"><RotateCcw className="w-5 h-5" /></button>
                                            <button onClick={() => setIsEquipModalOpen(false)} className="flex-1 py-3.5 text-slate-600 font-bold bg-slate-100 rounded-xl hover:bg-slate-200 transition-all">キャンセル</button>
                                            <button onClick={handleAddEquipment} disabled={!newEquipName || !newEquipDate} className="flex-[2] py-3.5 text-white font-bold bg-gradient-to-r from-slate-700 to-slate-900 rounded-xl hover:shadow-lg transition-all disabled:opacity-50 shadow-md active:scale-95">追加する</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isProfileModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-800"><UserIcon className="w-6 h-6 text-indigo-500" />設定・プロフィール</h3>
                                    <div className="space-y-6">
                                        <div><label className="block text-sm font-bold text-slate-700 mb-1 pl-1">表示名・氏名</label><input type="text" value={editUserName} onChange={(e) => setEditUserName(e.target.value)} placeholder="例：消防 太郎" className="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-slate-50/50" /><p className="text-xs text-slate-400 mt-2 ml-1">この名前はCSV出力時にも使用されます。</p></div>
                                        <div className="pt-4 border-t border-slate-100"><button onClick={handleResetAllData} className="w-full text-red-500 text-xs font-bold py-3 px-4 rounded-xl border border-red-100 hover:bg-red-50 flex items-center justify-center gap-2 transition-colors"><RefreshCw className="w-3 h-3" />全データを初期化（削除）する</button></div>
                                        <div className="flex gap-3 pt-2">
                                            <button onClick={() => setIsProfileModalOpen(false)} className="flex-1 py-3 text-slate-600 font-bold bg-slate-100 rounded-xl hover:bg-slate-200 transition-all">キャンセル</button>
                                            <button onClick={handleSaveProfile} className="flex-1 py-3 text-white font-bold bg-gradient-to-r from-indigo-500 to-blue-600 rounded-xl hover:shadow-lg transition-all shadow-md active:scale-95">保存する</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isManualModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-50 flex items-center justify-center p-4">
                                <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden relative animate-in zoom-in fade-in duration-300">
                                    <button onClick={() => setIsManualModalOpen(false)} className="absolute top-4 right-4 p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors z-20"><X className="w-5 h-5 text-slate-600" /></button>
                                    <div className="p-8 pb-20">
                                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><BookOpen className="w-6 h-6 text-orange-500" />アプリの使い方ガイド</h3>
                                        <div className="mb-6">
                                            <div className="aspect-video bg-slate-50 rounded-xl mb-4 overflow-hidden shadow-inner border border-slate-100 flex items-center justify-center">{manualSlides[manualPage].component}</div>
                                            <h4 className="text-lg font-bold text-slate-700 mb-2">{manualSlides[manualPage].title}</h4>
                                            <p className="text-sm text-slate-600 leading-relaxed">{manualSlides[manualPage].description}</p>
                                        </div>
                                    </div>
                                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                                        <div className="flex gap-1.5">{manualSlides.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full transition-all ${i === manualPage ? 'bg-orange-500 w-4' : 'bg-slate-300'}`} />))}</div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setManualPage(p => Math.max(0, p - 1))} disabled={manualPage === 0} className="p-2 rounded-full hover:bg-slate-200 disabled:opacity-30 transition-colors"><ChevronLeft className="w-6 h-6 text-slate-600" /></button>
                                            <button onClick={() => { if (manualPage === manualSlides.length - 1) { setIsManualModalOpen(false); } else { setManualPage(p => p + 1); } }} className="flex items-center gap-1 px-4 py-2 bg-slate-800 text-white rounded-full text-sm font-bold hover:bg-slate-700 transition-colors">{manualPage === manualSlides.length - 1 ? '完了' : '次へ'}{manualPage !== manualSlides.length - 1 && <ChevronRight className="w-4 h-4" />}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ActivityMaintenanceApp />);
    </script>
</body>
</html>
