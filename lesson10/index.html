<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現場活動指揮支援システム</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (JSX変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .timer-blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let app, auth, db;
        let isFirebaseAvailable = false;

        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY" && firebaseConfig.apiKey !== "") {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseAvailable = true;
            } else {
                console.warn("Firebase設定未完了。デモモードで動作。");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            isFirebaseAvailable = false;
        }

        const appId = 'safety-check-app-v8'; // v8 updated

        // --- Constants ---
        const COMMANDER_ROLE = { id: 'commander', label: '消防現場指揮隊', color: 'bg-orange-700' };

        const ENTRY_POINTS = [
            { id: 'window_2f', label: '2階掃き出し窓（クレセント周辺）', risk: '低', note: '修復容易・再施錠可' },
            { id: 'window_1f', label: '1階居室窓', risk: '中', note: '防犯リスクあり' },
            { id: 'entrance', label: '玄関ドア（サムターン/破壊）', risk: '高', note: '修復困難・高コスト' },
            { id: 'kitchen', label: '勝手口（ガラス）', risk: '低', note: '比較的安価' },
            { id: 'balcony_neighbor', label: '隣接ベランダ隔壁破壊', risk: '低', note: '賠償範囲に注意' },
        ];

        // --- Icons ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const ShieldAlert = (props) => <IconWrapper {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconWrapper>;
        const Search = (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconWrapper>;
        const LogOut = (props) => <IconWrapper {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconWrapper>;
        const UserCheck = (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></IconWrapper>;
        const Eye = (props) => <IconWrapper {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Lock = (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const User = (props) => <IconWrapper {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
        const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const PlusCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>;
        const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>;
        const Copy = (props) => <IconWrapper {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconWrapper>;
        const XIcon = (props) => <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
        const Eraser = (props) => <IconWrapper {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>;
        const Ambulance = (props) => <IconWrapper {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M15 7h4a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-4"/></IconWrapper>;
        const AlertTriangle = (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
        const Timer = (props) => <IconWrapper {...props}><line x1="10" y1="2" x2="14" y2="2"/><line x1="12" y1="14" x2="15" y2="11"/><circle cx="12" cy="14" r="8"/></IconWrapper>;
        const ClipboardCheck = (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>;

        // --- Main Component ---
        function SafetyCheckApp() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [view, setView] = useState('login');
            const [searchQuery, setSearchQuery] = useState('');
            const [residents, setResidents] = useState([]);
            const [selectedResident, setSelectedResident] = useState(null);
            const [isDemo, setIsDemo] = useState(!isFirebaseAvailable);
            
            // Modal State
            const [modal, setModal] = useState({ isOpen: false, type: '', message: '', onConfirm: null });
            
            // --- Editable Info State ---
            const [editInfo, setEditInfo] = useState({
                name: '', address: '', age: '', gender: '', history: '', note: '',
                transportStatus: '未定', hospital: '' 
            });

            // --- Tactical State ---
            const [reporterName, setReporterName] = useState('');
            const [reporterRelation, setReporterRelation] = useState('');
            const [hasAuthority, setHasAuthority] = useState(false);
            const [allWindowsChecked, setAllWindowsChecked] = useState(false);
            const [selectedEntryPoint, setSelectedEntryPoint] = useState('');
            const [isUrgent, setIsUrgent] = useState(false);
            const [activityLog, setActivityLog] = useState([]);
            const [loading, setLoading] = useState(false);

            // --- Time Management State ---
            const [timeStamps, setTimeStamps] = useState({ arrival: null, start: null, breach: null });
            const [elapsedSeconds, setElapsedSeconds] = useState(0);

            // --- Handover State ---
            const [handoverInfo, setHandoverInfo] = useState({ target: '', name: '', contact: '', note: '' });

            // --- Auth & Data Subs ---
            useEffect(() => {
                const init = async () => {
                    if (isFirebaseAvailable && auth) {
                        try {
                            await auth.signInAnonymously();
                        } catch (error) {
                            console.error("Auth Error, demo mode:", error);
                            setIsDemo(true);
                            setUser({ uid: 'demo-user', isAnonymous: true });
                        }
                    } else {
                        setIsDemo(true);
                        setUser({ uid: 'demo-user', isAnonymous: true });
                    }
                };
                init();

                if (isFirebaseAvailable && auth) {
                    auth.onAuthStateChanged((u) => u && setUser(u));
                }
            }, []);

            useEffect(() => {
                if (isDemo) return;
                if (!user || !db) return;
                
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public_data_residents')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setResidents(data);
                    }, (error) => {
                        console.error("Snapshot Error:", error);
                        setIsDemo(true);
                    });
                return () => unsubscribe();
            }, [user, isDemo]);

            // Timer Logic
            useEffect(() => {
                let interval;
                if (view === 'detail' && timeStamps.arrival) {
                    interval = setInterval(() => {
                        const now = new Date();
                        const arrival = new Date(timeStamps.arrival);
                        const diff = Math.floor((now - arrival) / 1000);
                        setElapsedSeconds(diff > 0 ? diff : 0);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [view, timeStamps.arrival]);

            const filteredResidents = residents.filter(r => (r.address?.includes(searchQuery) || r.name?.includes(searchQuery)));

            const formatTime = (isoString) => {
                if (!isoString) return '--:--';
                return new Date(isoString).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const formatElapsed = (sec) => {
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };

            const addLog = async (action, details = '') => {
                const time = new Date();
                const logEntry = {
                    timestamp: time.toISOString(),
                    displayTime: time.toLocaleTimeString('ja-JP'),
                    action,
                    details,
                    user: COMMANDER_ROLE.label
                };
                
                // Update Local
                setActivityLog(prev => [logEntry, ...prev]);
                if (selectedResident) {
                    const updatedResident = { ...selectedResident, activityLog: [logEntry, ...(selectedResident.activityLog || [])] };
                    setSelectedResident(updatedResident); 
                    
                    if (!isDemo && db) {
                        db.collection('artifacts').doc(appId).collection('public_data_residents').doc(selectedResident.id).update({
                            activityLog: firebase.firestore.FieldValue.arrayUnion(logEntry)
                        }).catch(console.error);
                    }
                }
            };

            const handleLogin = () => {
                setRole(COMMANDER_ROLE);
                setView('search');
            };

            const selectResident = (resident) => {
                setSelectedResident(resident);
                setEditInfo({
                    name: resident.name || '',
                    address: resident.address || '',
                    age: resident.age || '',
                    gender: resident.gender || '',
                    history: resident.history || '',
                    note: resident.note || '',
                    transportStatus: resident.transportStatus || '未定',
                    hospital: resident.hospital || ''
                });
                setReporterName('');
                setReporterRelation('');
                setHasAuthority(false);
                setAllWindowsChecked(false);
                setSelectedEntryPoint('');
                setIsUrgent(false);
                setActivityLog(resident.activityLog || []);
                
                // Time & Handover Restore
                setTimeStamps(resident.timeStamps || { arrival: null, start: null, breach: null });
                setHandoverInfo(resident.handoverInfo || { target: '', name: '', contact: '', note: '' });
                
                setView('detail');
            };

            // --- Action Logic ---
            const openModal = (type, message, onConfirm) => setModal({ isOpen: true, type, message, onConfirm });
            const closeModal = () => setModal({ isOpen: false, type: '', message: '', onConfirm: null });
            const confirmAction = () => { if(modal.onConfirm) modal.onConfirm(); closeModal(); };

            const clearAllInput = () => {
                setEditInfo({ name: '', address: '', age: '', gender: '', history: '', note: '', transportStatus: '未定', hospital: '' });
                setReporterName(''); setReporterRelation(''); setHasAuthority(false); setAllWindowsChecked(false); setSelectedEntryPoint(''); setIsUrgent(false);
                setHandoverInfo({ target: '', name: '', contact: '', note: '' });
            };

            const deleteCase = async () => {
                setLoading(true);
                try {
                    if (!isDemo && db && selectedResident) {
                        await db.collection('artifacts').doc(appId).collection('public_data_residents').doc(selectedResident.id).delete();
                    }
                    setResidents(prev => prev.filter(r => r.id !== selectedResident.id));
                    setSelectedResident(null);
                    setView('search');
                } catch(e) { console.error(e); alert('削除エラー'); } finally { setLoading(false); }
            };

            const saveResidentInfo = async () => {
                if (!selectedResident) return;
                try {
                    const updateData = { ...editInfo, timeStamps, handoverInfo };
                    const updatedResident = { ...selectedResident, ...updateData };
                    setSelectedResident(updatedResident);
                    setResidents(prev => prev.map(r => r.id === selectedResident.id ? updatedResident : r));

                    if (!isDemo && db) {
                        await db.collection('artifacts').doc(appId).collection('public_data_residents').doc(selectedResident.id).update(updateData);
                    }
                    addLog('情報保存', '基本・時間・申し送り情報の更新');
                    alert('情報を保存しました');
                } catch (e) { console.error(e); alert('保存失敗'); }
            };

            const recordTimestamp = async (type, label) => {
                if (!selectedResident) return;
                if (timeStamps[type]) return; // 既に記録済み

                const now = new Date();
                const newTimeStamps = { ...timeStamps, [type]: now.toISOString() };
                setTimeStamps(newTimeStamps);
                
                // データベース更新
                if (!isDemo && db) {
                    await db.collection('artifacts').doc(appId).collection('public_data_residents').doc(selectedResident.id).update({
                        timeStamps: newTimeStamps
                    });
                }
                addLog(`時刻記録: ${label}`, formatTime(now.toISOString()));
            };

            const createQuickCase = async () => {
                setLoading(true);
                try {
                    const initialData = {
                        name: '（名称未定）', address: '', status: '活動中', age: '', gender: '', history: '', note: '',
                        transportStatus: '未定', hospital: '',
                        createdAt: isDemo ? new Date() : firebase.firestore.FieldValue.serverTimestamp(),
                        activityLog: [],
                        timeStamps: { arrival: null, start: null, breach: null },
                        handoverInfo: { target: '', name: '', contact: '', note: '' }
                    };

                    if (!isDemo && db) {
                        const docRef = await db.collection('artifacts').doc(appId).collection('public_data_residents').add(initialData);
                        const newResident = { id: docRef.id, ...initialData, createdAt: new Date() }; 
                        selectResident(newResident); 
                    } else {
                        const newResident = { id: 'demo-' + Date.now(), ...initialData };
                        setResidents(prev => [newResident, ...prev]);
                        selectResident(newResident);
                    }
                } catch (e) { console.error(e); alert('作成エラー'); } finally { setLoading(false); }
            };

            const executeCommand = async () => {
                if (!user || !selectedResident) return;
                if (!isUrgent) {
                    if (!allWindowsChecked) { alert('【安全管理】全開口部の施錠確認が完了していません。'); return; }
                    if (!hasAuthority && !confirm('権限者の同意が未確認です。強行しますか？')) return;
                    if (!selectedEntryPoint) { alert('破壊箇所を選択してください。'); return; }
                }

                setLoading(true);
                try {
                    const entryMethod = isUrgent ? '緊急最短経路' : ENTRY_POINTS.find(p => p.id === selectedEntryPoint)?.label;
                    
                    // 破壊時間を自動記録
                    const now = new Date();
                    let newTimeStamps = { ...timeStamps };
                    if (!newTimeStamps.breach) {
                        newTimeStamps.breach = now.toISOString();
                        setTimeStamps(newTimeStamps);
                    }

                    const finalLogEntry = {
                        timestamp: now.toISOString(),
                        displayTime: now.toLocaleTimeString('ja-JP'),
                        action: '破壊指示発出',
                        details: `方法: ${entryMethod} / 同意: ${hasAuthority ? 'あり' : 'なし'}`,
                        user: COMMANDER_ROLE.label
                    };

                    const updatedData = {
                        status: '救助活動中（破壊介入）',
                        lastUpdated: isDemo ? new Date() : firebase.firestore.FieldValue.serverTimestamp(),
                        timeStamps: newTimeStamps
                    };

                    const updatedResident = { ...selectedResident, ...updatedData, activityLog: [...(selectedResident.activityLog || []), finalLogEntry] };
                    setSelectedResident(updatedResident);
                    setResidents(prev => prev.map(r => r.id === selectedResident.id ? updatedResident : r));
                    setActivityLog(prev => [finalLogEntry, ...prev]);

                    if (!isDemo && db) {
                        const docRef = db.collection('artifacts').doc(appId).collection('public_data_residents').doc(selectedResident.id);
                        await docRef.update({
                            ...updatedData,
                            activityLog: firebase.firestore.FieldValue.arrayUnion(finalLogEntry)
                        });
                    }
                    alert('破壊指示を記録しました。');
                } catch (e) { console.error(e); alert('記録エラー'); } finally { setLoading(false); }
            };

            const exportLogToClipboard = () => {
                const text = `【活動ログ・申し送り】\n事案: ${selectedResident?.name || '名称未定'}\n` +
                             `--------------------------------\n` +
                             `現着時刻: ${formatTime(timeStamps.arrival)}\n` +
                             `開始時刻: ${formatTime(timeStamps.start)}\n` +
                             `破壊時刻: ${formatTime(timeStamps.breach)}\n` +
                             `--------------------------------\n` +
                             `搬送: ${editInfo.transportStatus} (${editInfo.hospital})\n` +
                             `引継: ${handoverInfo.target} ${handoverInfo.name} (${handoverInfo.contact})\n` +
                             `--------------------------------\n` +
                             activityLog.map(l => `[${l.displayTime}] ${l.action} ${l.details || ''}`).join('\n');
                
                const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                alert('コピーしました');
            };

            // --- Views ---
            if (view === 'login') {
                return (
                    <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center p-4">
                        <div className="w-full max-w-sm space-y-6">
                            <div className="text-center">
                                <ShieldAlert size={64} className="mx-auto text-orange-500 mb-4" />
                                <h1 className="text-2xl font-bold">現場活動指揮支援</h1>
                                {isDemo && <p className="text-yellow-400 text-xs mt-2 border border-yellow-600 p-1 rounded">デモモード動作中</p>}
                            </div>
                            <button onClick={handleLogin} className="w-full bg-orange-700 hover:bg-orange-600 p-6 rounded-lg font-bold flex justify-between items-center shadow-lg active:scale-95 transition-all">
                                <span className="text-xl">現場活動を開始</span>
                                <ArrowRight size={24} />
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 pb-24 relative">
                    {/* Modal */}
                    {modal.isOpen && (
                        <div className="fixed inset-0 modal-overlay flex items-center justify-center z-[100] animate-fade-in p-4">
                            <div className="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center">
                                <div className="flex justify-center mb-4 text-orange-600"><AlertTriangle size={48} /></div>
                                <h3 className="text-lg font-bold mb-2">{modal.type}</h3>
                                <p className="text-sm text-gray-600 mb-6 whitespace-pre-wrap">{modal.message}</p>
                                <div className="flex gap-2">
                                    <button onClick={closeModal} className="flex-1 py-3 rounded bg-gray-200 text-gray-800 font-bold">キャンセル</button>
                                    <button onClick={confirmAction} className="flex-1 py-3 rounded bg-red-600 text-white font-bold">実行する</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className={`${COMMANDER_ROLE.color} text-white p-3 sticky top-0 z-50 shadow-md flex justify-between items-center`}>
                        <div className="flex items-center space-x-2 cursor-pointer" onClick={() => setView('search')}>
                            <ShieldAlert size={20} />
                            <span className="font-bold text-sm">活動記録 ({COMMANDER_ROLE.label})</span>
                        </div>
                        <div className="flex items-center gap-2 cursor-pointer p-2" onClick={() => setView('login')}>
                            <span className="text-xs font-bold">ログアウト</span>
                            <LogOut size={18} />
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-3 space-y-4">
                        {view === 'search' && (
                            <div className="animate-fade-in space-y-4">
                                <button 
                                    onClick={createQuickCase}
                                    disabled={loading}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-lg font-bold shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-all"
                                >
                                    <PlusCircle size={28} />
                                    <span className="text-xl">新規活動を開始 (事案作成)</span>
                                </button>

                                <div className="bg-white p-3 rounded shadow flex items-center gap-2">
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="過去の事案を検索..." className="flex-1 p-2 bg-transparent outline-none" />
                                    <Search className="text-slate-400" />
                                </div>

                                <div className="space-y-2">
                                    {filteredResidents.map(r => (
                                        <div key={r.id} onClick={() => selectResident(r)} className="bg-white p-4 rounded shadow border-l-4 border-slate-700 active:bg-slate-100 cursor-pointer">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="font-bold text-lg">{r.name}</h3>
                                                    <p className="text-slate-600 text-xs">{r.address || '住所未入力'}</p>
                                                </div>
                                                <span className="text-xs bg-slate-100 px-2 py-1 rounded">{r.status}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {residents.length === 0 && <p className="text-center text-slate-400 text-sm py-4">履歴なし</p>}
                                </div>
                            </div>
                        )}

                        {view === 'detail' && selectedResident && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex justify-between items-center">
                                    <button onClick={() => setView('search')} className="text-xs text-slate-500 bg-white px-3 py-2 rounded border shadow-sm">← 一覧</button>
                                    <div className="flex gap-2">
                                        <button onClick={() => openModal('入力全クリア', '入力内容を全て白紙に戻しますか？', clearAllInput)} type="button" className="text-xs text-slate-600 bg-slate-100 px-3 py-2 rounded border hover:bg-slate-200 flex items-center gap-1 active:scale-95"><Eraser size={14} /> 入力クリア</button>
                                        <button onClick={() => openModal('事案削除', 'この事案を完全に削除しますか？', deleteCase)} type="button" className="text-xs text-red-600 bg-red-50 px-3 py-2 rounded border border-red-200 hover:bg-red-100 flex items-center gap-1 active:scale-95"><Trash2 size={14} /> 削除</button>
                                    </div>
                                </div>

                                {/* 0. Time Management Panel */}
                                <div className="bg-slate-800 text-white p-4 rounded-lg shadow-lg">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold flex items-center gap-2 text-sm"><Timer size={18}/> 活動時間管理</h3>
                                        <div className={`text-xl font-mono font-bold ${timeStamps.arrival ? 'timer-blink text-green-400' : 'text-slate-500'}`}>
                                            経過: {formatElapsed(elapsedSeconds)}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <button onClick={() => recordTimestamp('arrival', '現場到着')} className={`p-2 rounded text-sm font-bold border transition-colors ${timeStamps.arrival ? 'bg-green-700 border-green-500 text-white' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'}`}>
                                            {timeStamps.arrival ? `現着 ${formatTime(timeStamps.arrival)}` : '現場到着'}
                                        </button>
                                        <button onClick={() => recordTimestamp('start', '活動開始')} className={`p-2 rounded text-sm font-bold border transition-colors ${timeStamps.start ? 'bg-blue-700 border-blue-500 text-white' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'}`}>
                                            {timeStamps.start ? `開始 ${formatTime(timeStamps.start)}` : '活動開始'}
                                        </button>
                                        <div className={`p-2 rounded text-sm font-bold border flex items-center justify-center ${timeStamps.breach ? 'bg-red-900 border-red-500 text-red-200' : 'bg-slate-900 border-slate-700 text-slate-600'}`}>
                                            {timeStamps.breach ? `破壊 ${formatTime(timeStamps.breach)}` : '破壊未実施'}
                                        </div>
                                    </div>
                                </div>

                                {/* 1. Basic Info */}
                                <div className="bg-white p-4 rounded shadow-sm border-t-4 border-blue-500">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><User size={18} /> 傷病者・現場情報</h3>
                                        <button onClick={saveResidentInfo} className="text-xs bg-blue-600 text-white px-3 py-2 rounded flex items-center gap-1 shadow font-bold active:scale-95"><Save size={14} /> 保存</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                        <div className="col-span-1">
                                            <label className="block text-slate-500 text-xs font-bold">氏名</label>
                                            <input type="text" value={editInfo.name} onChange={(e) => setEditInfo({...editInfo, name: e.target.value})} className="w-full p-2 border rounded bg-slate-50" placeholder="氏名" />
                                        </div>
                                        <div className="col-span-1 flex gap-2">
                                            <input type="text" value={editInfo.age} onChange={(e) => setEditInfo({...editInfo, age: e.target.value})} className="w-1/2 p-2 border rounded bg-slate-50" placeholder="歳" />
                                            <select value={editInfo.gender} onChange={(e) => setEditInfo({...editInfo, gender: e.target.value})} className="w-1/2 p-2 border rounded bg-slate-50"><option value="">不明</option><option value="男性">男性</option><option value="女性">女性</option></select>
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-slate-500 text-xs font-bold">住所</label>
                                            <input type="text" value={editInfo.address} onChange={(e) => setEditInfo({...editInfo, address: e.target.value})} className="w-full p-2 border rounded bg-slate-50" placeholder="現着住所" />
                                        </div>
                                        {/* Transport Info */}
                                        <div className="col-span-2 bg-blue-50 p-2 rounded border border-blue-100">
                                            <label className="block text-blue-800 text-xs font-bold mb-1 flex items-center gap-1"><Ambulance size={14}/> 発見後の処置・搬送情報</label>
                                            <div className="flex gap-2 mb-2">
                                                <select className="w-1/2 p-2 border rounded text-sm" value={editInfo.transportStatus} onChange={(e) => setEditInfo({...editInfo, transportStatus: e.target.value})}>
                                                    <option value="未定">未定</option>
                                                    <option value="医療機関へ搬送">医療機関へ搬送</option>
                                                    <option value="不搬送（現場処置）">不搬送（現場処置）</option>
                                                    <option value="不搬送（本人拒否）">不搬送（本人拒否）</option>
                                                    <option value="不搬送（死亡確認）">不搬送（死亡確認）</option>
                                                </select>
                                                <input type="text" className="w-1/2 p-2 border rounded text-sm" placeholder="搬送先医療機関名" value={editInfo.hospital} onChange={(e) => setEditInfo({...editInfo, hospital: e.target.value})} />
                                            </div>
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-slate-500 text-xs font-bold">特記事項</label>
                                            <textarea value={editInfo.history} onChange={(e) => setEditInfo({...editInfo, history: e.target.value})} className="w-full p-2 border rounded bg-slate-50 h-16" placeholder="病歴・状況など" />
                                        </div>
                                    </div>
                                </div>

                                {/* 2. Reporter */}
                                <div className="bg-white p-4 rounded shadow-sm border-t-4 border-green-500">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-3"><UserCheck size={18} /> 通報者・権限</h3>
                                    <div className="space-y-3">
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="関係者氏名" className="flex-1 p-2 border rounded text-sm" value={reporterName} onChange={(e) => setReporterName(e.target.value)} />
                                            <select className="flex-1 p-2 border rounded text-sm" value={reporterRelation} onChange={(e) => setReporterRelation(e.target.value)}><option value="">関係性...</option><option>親族</option><option>管理会社</option><option>警察</option><option>隣人</option></select>
                                        </div>
                                        <label className={`flex items-center p-3 rounded border-2 cursor-pointer transition-colors ${hasAuthority ? 'bg-green-100 border-green-500' : 'bg-slate-50'}`}>
                                            <input type="checkbox" checked={hasAuthority} onChange={(e) => setHasAuthority(e.target.checked)} className="w-5 h-5 text-green-600" />
                                            <span className="ml-2 font-bold text-sm">破壊許可権限者として認定</span>
                                        </label>
                                    </div>
                                </div>

                                {/* 3. Tactical */}
                                <div className="bg-white p-4 rounded shadow-sm border-t-4 border-orange-500">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Eye size={18} /> 検索・破壊箇所</h3>
                                        <button onClick={() => setIsUrgent(!isUrgent)} className={`text-xs px-2 py-1 rounded font-bold ${isUrgent ? 'bg-red-600 text-white' : 'bg-slate-200'}`}>{isUrgent ? '緊急モードON' : '緊急モードOFF'}</button>
                                    </div>
                                    {!isUrgent && (
                                        <div className="space-y-3">
                                            <label className={`flex items-center p-3 rounded border cursor-pointer ${allWindowsChecked ? 'bg-blue-50 border-blue-500' : 'bg-slate-50'}`}>
                                                <input type="checkbox" checked={allWindowsChecked} onChange={(e) => setAllWindowsChecked(e.target.checked)} className="w-5 h-5 text-blue-600" />
                                                <span className="ml-2 font-bold text-sm">全開口部の施錠確認（必須）</span>
                                            </label>
                                            <div className="space-y-1">
                                                <p className="text-xs font-bold text-slate-500">破壊箇所の選定</p>
                                                {ENTRY_POINTS.map(p => (
                                                    <label key={p.id} className={`flex justify-between p-2 border rounded cursor-pointer text-sm ${selectedEntryPoint === p.id ? 'bg-orange-100 border-orange-500' : ''}`}>
                                                        <span><input type="radio" name="ep" checked={selectedEntryPoint === p.id} onChange={() => setSelectedEntryPoint(p.id)} className="mr-2" />{p.label}</span>
                                                        <span className="text-xs bg-white px-1 rounded border">{p.risk}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <button onClick={executeCommand} disabled={loading} className="w-full mt-4 py-4 rounded font-bold text-white shadow-lg bg-slate-800 hover:bg-slate-700 active:scale-95 flex justify-center items-center gap-2">
                                        <Lock size={20} /> {isUrgent ? '緊急破壊実行' : '破壊活動 指示'}
                                    </button>
                                </div>

                                {/* 4. Handover & End */}
                                <div className="bg-white p-4 rounded shadow-sm border-t-4 border-purple-500">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-3"><ClipboardCheck size={18} /> 現場引き継ぎ・活動終了</h3>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex gap-2">
                                            <select className="w-1/3 p-2 border rounded" value={handoverInfo.target} onChange={(e) => setHandoverInfo({...handoverInfo, target: e.target.value})}>
                                                <option value="">引継先...</option>
                                                <option value="警察">警察</option>
                                                <option value="親族">親族</option>
                                                <option value="管理会社">管理会社</option>
                                                <option value="その他">その他</option>
                                            </select>
                                            <input type="text" className="flex-1 p-2 border rounded" placeholder="氏名・担当者名" value={handoverInfo.name} onChange={(e) => setHandoverInfo({...handoverInfo, name: e.target.value})} />
                                        </div>
                                        <input type="text" className="w-full p-2 border rounded" placeholder="連絡先・備考" value={handoverInfo.contact} onChange={(e) => setHandoverInfo({...handoverInfo, contact: e.target.value})} />
                                    </div>
                                </div>

                                {/* 5. Log */}
                                <div className="bg-slate-100 p-4 rounded shadow-inner border">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-slate-600 text-sm flex gap-1"><Clock size={16} /> 活動ログ</h3>
                                        <button onClick={exportLogToClipboard} className="text-xs bg-white border px-2 py-1 rounded">コピー</button>
                                    </div>
                                    <div className="text-xs space-y-2 pl-2 border-l-2 border-slate-300">
                                        {activityLog.map((l, i) => (
                                            <div key={i}>
                                                <span className="font-mono text-slate-500">{l.displayTime}</span> <span className="font-bold">{l.action}</span> {l.details}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SafetyCheckApp />);
    </script>
</body>
</html>
